<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>[智能家居]小爱语音控制HA设备</title>
    <link href="/2025/02/14/2025-02-14-xiaoai-voice-control-for-ha-devices/"/>
    <url>/2025/02/14/2025-02-14-xiaoai-voice-control-for-ha-devices/</url>
    
    <content type="html"><![CDATA[<p>我使用HA作为家居设备控制中枢，接入了米家、aqara homekit、美的等多个平台设备。虽然在HA自动化中可以配合工作，但我使用的小爱音箱无法语音控制非米家平台设备，操作不方便。<br>有什么方式可以打通实现语音控制呢。</p><span id="more"></span><h2 id="接入方案"><a href="#接入方案" class="headerlink" title="接入方案"></a>接入方案</h2><p>整理一下，方法有</p><ol><li>Siri音箱 + homekit bridge。通过Siri语音可以控制所有HA设备了</li><li>借助yeelight pro网关，虚拟米家设备和HA设备绑定</li><li>米极桥方案。用米极桥做虚拟开关，和HA设备绑定</li><li>中枢网关方案。用中枢网关的虚拟事件配合ha_xiaomi_home，可以通过虚拟事件传递文本信息做控制</li><li>小爱音箱对话记录方案。轮询监听小爱音箱的语音文记录，解析并控制HA设备</li><li>三方平台方案。将HA设备用巴法云以第三方平台方式接入米家</li></ol><p>以上方案中，巴法云是纯软件方式，接入方式较简单，不需要额外购买设备。缺点是依赖第三方平台，可能不稳定。<br>我的使用场景是用小爱语音开启/关闭美的除湿机。语音跨平台操作设备频率极低，稳定性因素影响可以忽略，所以采用巴法云接入。</p><h2 id="接入原理"><a href="#接入原理" class="headerlink" title="接入原理"></a>接入原理</h2><p>注册bemfa账号，用bemfa打通米家和ha。</p><img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjI2OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MzE3cHg7aGVpZ2h0OjI2OXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDMxNyAyNjkiIHdpZHRoPSIzMTdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxnPjx0aXRsZT5Vc2VyPC90aXRsZT48cmVjdCBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTA3LjM5ODQiIHdpZHRoPSI4IiB4PSIxOS45NTUxIiB5PSI4MS4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjIzIiB4Mj0iMjMiIHkxPSI4MS4yOTY5IiB5Mj0iMTg4LjY5NTMiLz48L2c+PGc+PHRpdGxlPm1pX2hvbWU8L3RpdGxlPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIxMDcuMzk4NCIgd2lkdGg9IjgiIHg9Ijk1Ljk1NTEiIHk9IjgxLjI5NjkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iOTkuODQ2NyIgeDI9Ijk5Ljg0NjciIHkxPSI4MS4yOTY5IiB5Mj0iMTg4LjY5NTMiLz48L2c+PGc+PHRpdGxlPmJlbWZhPC90aXRsZT48cmVjdCBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTA3LjM5ODQiIHdpZHRoPSI4IiB4PSIxNzQuMzg2MyIgeT0iODEuMjk2OSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIxNzguMDYzNSIgeDI9IjE3OC4wNjM1IiB5MT0iODEuMjk2OSIgeTI9IjE4OC42OTUzIi8+PC9nPjxnPjx0aXRsZT5oYTwvdGl0bGU+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjEwNy4zOTg0IiB3aWR0aD0iOCIgeD0iMjkxLjYzOTgiIHk9IjgxLjI5NjkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iMjk0LjkxMzciIHgyPSIyOTQuOTEzNyIgeTE9IjgxLjI5NjkiIHkyPSIxODguNjk1MyIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMS45MTAyIiB4PSI1IiB5PSI3Ny45OTUxIj5Vc2VyPC90ZXh0PjxlbGxpcHNlIGN4PSIyMy45NTUxIiBjeT0iMTMuNSIgZmlsbD0iI0UyRTJGMCIgcng9IjgiIHJ5PSI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMjMuOTU1MSwyMS41IEwyMy45NTUxLDQ4LjUgTTEwLjk1NTEsMjkuNSBMMzYuOTU1MSwyOS41IE0yMy45NTUxLDQ4LjUgTDEwLjk1NTEsNjMuNSBNMjMuOTU1MSw0OC41IEwzNi45NTUxLDYzLjUgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMS45MTAyIiB4PSI1IiB5PSIyMDAuNjkwNCI+VXNlcjwvdGV4dD48ZWxsaXBzZSBjeD0iMjMuOTU1MSIgY3k9IjIxMi40OTIyIiBmaWxsPSIjRTJFMkYwIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0yMy45NTUxLDIyMC40OTIyIEwyMy45NTUxLDI0Ny40OTIyIE0xMC45NTUxLDIyOC40OTIyIEwzNi45NTUxLDIyOC40OTIyIE0yMy45NTUxLDI0Ny40OTIyIEwxMC45NTUxLDI2Mi40OTIyIE0yMy45NTUxLDI0Ny40OTIyIEwzNi45NTUxLDI2Mi40OTIyICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48L2c+PGc+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3OC4yMTY4IiB4PSI2MC44NDY3IiB5PSI1MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY0LjIxNjgiIHg9IjY3Ljg0NjciIHk9IjY5Ljk5NTEiPm1pX2hvbWU8L3RleHQ+PC9nPjxnPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzguMjE2OCIgeD0iNjAuODQ2NyIgeT0iMTg3LjY5NTMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NC4yMTY4IiB4PSI2Ny44NDY3IiB5PSIyMDcuNjkwNCI+bWlfaG9tZTwvdGV4dD48L2c+PGc+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1OC42NDU1IiB4PSIxNDkuMDYzNSIgeT0iNTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NC42NDU1IiB4PSIxNTYuMDYzNSIgeT0iNjkuOTk1MSI+YmVtZmE8L3RleHQ+PC9nPjxnPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTguNjQ1NSIgeD0iMTQ5LjA2MzUiIHk9IjE4Ny42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDQuNjQ1NSIgeD0iMTU2LjA2MzUiIHk9IjIwNy42OTA0Ij5iZW1mYTwvdGV4dD48L2c+PGc+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzMS40NTIxIiB4PSIyNzkuOTEzNyIgeT0iNTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNy40NTIxIiB4PSIyODYuOTEzNyIgeT0iNjkuOTk1MSI+aGE8L3RleHQ+PC9nPjxnPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzEuNDUyMSIgeD0iMjc5LjkxMzciIHk9IjE4Ny42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTcuNDUyMSIgeD0iMjg2LjkxMzciIHk9IjIwNy42OTA0Ij5oYTwvdGV4dD48L2c+PGc+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI4Ny45NTUxLDEwOC40Mjk3LDk3Ljk1NTEsMTEyLjQyOTcsODcuOTU1MSwxMTYuNDI5Nyw5MS45NTUxLDExMi40Mjk3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjIzLjk1NTEiIHgyPSI5My45NTUxIiB5MT0iMTEyLjQyOTciIHkyPSIxMTIuNDI5NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjMwLjk1NTEiIHk9IjEwNy4zNjM4Ij4mIzM1ODIxOyYjMzg4OTk7JiMyNTM1MTsmIzIwMTk2OzwvdGV4dD48L2c+PGc+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNjYuMzg2MywxMzcuNTYyNSwxNzYuMzg2MywxNDEuNTYyNSwxNjYuMzg2MywxNDUuNTYyNSwxNzAuMzg2MywxNDEuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI5OS45NTUxIiB4Mj0iMTcyLjM4NjMiIHkxPSIxNDEuNTYyNSIgeTI9IjE0MS41NjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIuMDAwMSIgeD0iMTA2Ljk1NTEiIHk9IjEzNi40OTY2Ij4mIzI1NTExOyYjMjEwNDY7JiMyNTM1MTsmIzIwMTk2OzwvdGV4dD48L2c+PGc+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI5My42Mzk4IiB4Mj0iMjgzLjYzOTgiIHkxPSIxNzAuNjk1MyIgeTI9IjE2Ni42OTUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI5My42Mzk4IiB4Mj0iMjgzLjYzOTgiIHkxPSIxNzAuNjk1MyIgeTI9IjE3NC42OTUzIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjE3OC4zODYzIiB4Mj0iMjk0LjYzOTgiIHkxPSIxNzAuNjk1MyIgeTI9IjE3MC42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTMuMjUzNSIgeD0iMTg1LjM4NjMiIHk9IjE2NS42Mjk0Ij4mIzI4MDQwOyYjMjQ2ODc7JiMzNjg5MDsmIzMwNjkzOyhtcXR0KTwvdGV4dD48L2c+PCEtLVNSQz1bSXFta29JekkyMnJFQlU4Z0kybWdvS3BFQjRaQ0FyNzhwT3BGb0N6REhINUJJaXJESXFHSG9LWmF1VzlmTFQyclctY21LZFluVmt0Qi1Qa1Z6Ukdfc1JzNDJvZUFLVzNNUmdObWg2X3ZxdXZqSzZjbTY1M0kzY1dLSzZmUm54RjZ6SXlSUFpzVmxyR1pqeDJhSDFDMF0tLT48L2c+PC9zdmc+'><h2 id="接入步骤"><a href="#接入步骤" class="headerlink" title="接入步骤"></a>接入步骤</h2><h3 id="1-注册巴法云账号，保存私钥"><a href="#1-注册巴法云账号，保存私钥" class="headerlink" title="1 注册巴法云账号，保存私钥"></a>1 注册<a href="https://bemfa.com/">巴法云</a>账号，保存<strong>私钥</strong></h3><p>按网页操作即可。</p><h3 id="2-HA安装bemfa集成"><a href="#2-HA安装bemfa集成" class="headerlink" title="2 HA安装bemfa集成"></a>2 HA安装<a href="https://github.com/wanghuizzz/bemfa">bemfa集成</a></h3><p>注意原版集成由于bemfa api更新，已不可用，需要安装<a href="https://github.com/wanghuizzz/bemfa">修改版</a>。<br>截至 2025-02-14，修改版可正常使用。</p><h3 id="3-配置bemfa集成，配置需要暴露给米家控制的设备实体"><a href="#3-配置bemfa集成，配置需要暴露给米家控制的设备实体" class="headerlink" title="3 配置bemfa集成，配置需要暴露给米家控制的设备实体"></a>3 配置bemfa集成，配置需要暴露给米家控制的设备实体</h3><p>在HA设备页面增加bemfa集成，再从bemfa集成页面选择同步设备实体。<br>巴法云支持设备有限，一般用“开关”或“灯光”兼容性好点。</p><blockquote><p>巴法云 支持设备<br>001    插座设备<br>002    灯泡设备<br>003    风扇设备<br>004    传感器<br>005    空调设备<br>006    开关设备<br>009    窗帘设备</p></blockquote><p>配置完成后，到<a href="https://cloud.bemfa.com/tcp/devicemqtt.html">bemfa控制台</a>检查是否同步创建topic成功。</p><h3 id="4-米家APP第三方平台授权-amp-同步设备"><a href="#4-米家APP第三方平台授权-amp-同步设备" class="headerlink" title="4 米家APP第三方平台授权&amp;同步设备"></a>4 米家APP第三方平台授权&amp;同步设备</h3><p>在米家APP按指引操作接入第三方平台，并同步设备。<br>小爱语音测试是否正常控制。</p>]]></content>
    
    
    
    <tags>
      
      <tag>HA</tag>
      
      <tag>智能家居</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[智能家居]HomeAssistant折腾笔记</title>
    <link href="/2025/01/09/2025-01-09-deploy-home-assistant/"/>
    <url>/2025/01/09/2025-01-09-deploy-home-assistant/</url>
    
    <content type="html"><![CDATA[<p>最近开始折腾智能家居。试用过米家、涂鸦和homekit后, 觉得Home Assistant(HA)方案最符合我的需求。<br>这个系列整理HA的部署笔记,作为总结,方便以后查阅。</p><span id="more"></span><h2 id="Why-HA？"><a href="#Why-HA？" class="headerlink" title="Why HA？"></a>Why HA？</h2><p>HA的优点</p><ul><li>跨平台支持。可以接入米家、homekit等不同平台</li><li>强大编程能力。自带自动化引擎很强大,支持并行、延时、条件控制；除此之外还可以接入node-red图形化编程</li><li>本地化。本地计算, 一般响应更快, 对网络依赖低</li><li>强大社区支持。插件更新频繁, 遇到问题很容易找到解决方案</li></ul><p>缺点是, 有一定学习成本。<br>如果喜欢折腾, 就直接上HA吧。用其它平台或多或少都会遇的问题, 在HA常常可以很容易地解决。<br>比如, 米家极客版, 为了实现寄存器功能, 需要购买硬件“米极桥”, 或者用虚拟事件曲线实现。但在HA, 定义个虚拟开关即可解决。</p><h2 id="HA部署"><a href="#HA部署" class="headerlink" title="HA部署"></a>HA部署</h2><p>HA官方提供有<a href="https://www.home-assistant.io/installation">四种部署方式</a>, 我推荐使用<strong>Container</strong>方式。<br>Container相对精简, 常用add-ons也能通过插件方式实现, 备份和迁移更加方便。</p><p>HA对硬件要求极低（建议1GB以上内存和16GB以上存储空间）, 适合跑在软路由、nas或armbian盒子。<br>我以armbian盒子为例演示。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># armbian安装docker</span><br>apt install docker.io<br><span class="hljs-comment"># 运行ha容器, 启动用使用:8123端口访问服务</span><br>docker run -itd --net=host --restart always --name=<span class="hljs-string">&quot;hass&quot;</span> -v /data/hass/config:/config homeassistant/home-assistant:latest<br></code></pre></td></tr></table></figure><h2 id="安装扩展"><a href="#安装扩展" class="headerlink" title="安装扩展"></a>安装扩展</h2><h3 id="安装HACS"><a href="#安装HACS" class="headerlink" title="安装HACS"></a>安装HACS</h3><p><a href="https://github.com/hacs/integration">HACS</a>是个插件库, 很方便安装第三方插件。<br>下载最新release包, 解压到<code>/data/hass/config/custom_components/hacs</code>, 重启hass。<br>重启完成后, 依次 设置-增加集成-搜hacs, 按引导配置即可。</p><h3 id="安装米家扩展"><a href="#安装米家扩展" class="headerlink" title="安装米家扩展"></a>安装米家扩展</h3><p>截至2025-01-09, 米家的集成方式有3种</p><ul><li><a href="https://github.com/XiaoMi/ha_xiaomi_home">ha_xiaomi_home</a>,官方集成, 功能不完善, 支持部分wifi设备本地化控制, 不支持蓝牙设备本地化控制, 正在快速迭代更新中</li><li><a href="https://github.com/al-one/hass-xiaomi-miot">hass-xiaomi-miot</a>,开源方案, 同官方支持部分wifi本地化控制, 但状态更新有延迟</li><li><a href="https://github.com/AlexxIT/XiaomiGateway3">XiaomiGateway3</a>, 开源方案, 支持蓝牙设备本地化控制, 需要购买特定版本网关</li></ul><p>目前最稳定的方案是hass-xiaomi-miot + XiaomiGateway3。XiaomiGateway3用于接入蓝牙设备, 其它设备使用hass-xiaomi-miot接入, 实现大部分设备本地化控制。状态更新延迟问题不太重要。</p><p>安装方法。从HACS页面搜相应插件安装, 重启HA。在“集成”页面增加插件集成, 按引导配置即可。<br>建议使用<em>Include</em>方式手动添加设备, 避免导入太多不需要接入的设备和实体。</p><h3 id="安装node-red-可选"><a href="#安装node-red-可选" class="headerlink" title="安装node-red(可选)"></a>安装node-red(可选)</h3><p>node-red是个强大的add-on, 可以实现图形化通用编程扩展。类似于米家极客版, 但功能更强大。支持第三方js库, 可以实现推微信消息等功能。<br>Container版本HA不支持add-on功能, 但可以手动安装。原理是, docker运行node-red服务, 配置打通两个系统。</p><p>首先, HA通过HACS安装“Node-RED Companion”插件, 方法与安装米家插件相同。<br>然后运行node-red服务</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 1880端口访问服务</span><br>docker <span class="hljs-builtin-name">run</span> <span class="hljs-attribute">--restart</span>=always -e <span class="hljs-attribute">TZ</span>=<span class="hljs-string">&quot;Asia/Shanghai&quot;</span> -d <span class="hljs-attribute">--net</span>=host -v /data/nodered_data:/data --name nodered nodered/node-red<br></code></pre></td></tr></table></figure><p>再访问node-red管理页面, 安装<code>node-red-contrib-home-assistant-websocket</code>节点, 按提示配置即可。</p><h2 id="接入Apple-Home"><a href="#接入Apple-Home" class="headerlink" title="接入Apple Home"></a>接入Apple Home</h2><p>使用HomeBridge接入Apple Home, 可以实现用Siri操作HA上设备。<br>HA自带HomeBridge集成。在集成页面增加HomeBridge, 选择要接入的设备。用iphone扫二维码接入即可。</p><h2 id="自动化案例"><a href="#自动化案例" class="headerlink" title="自动化案例"></a>自动化案例</h2><p>虽然node-red很强大, 但大部分场景HA自动化已够用, 而且少一层通信, 时延更低。所以我更建议HA自动化。</p><p>常用自动化分享</p><ul><li>离家。关闭空调、灯, 打开监控</li><li>回家。由门锁或传感器自动触发, 关监控, 天黑自动开灯, 音箱播放欢迎信息</li><li>晚安。关灯、关客厅空调, 开监控</li><li>早安。时间+人体传感器自动触发, 关监控、音箱播放早安信息&amp;天气&amp;新闻</li><li>夜间开关灯。时间、晚安状态配合人体传感器自动触发</li><li>潮湿自动抽湿, 干燥自动加湿。</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>HA</tag>
      
      <tag>智能家居</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker部署Gitlab CE</title>
    <link href="/2024/09/14/2024-09-14-deploy-gitlab-ce/"/>
    <url>/2024/09/14/2024-09-14-deploy-gitlab-ce/</url>
    
    <content type="html"><![CDATA[<p>Gitlab是开发中一个重要的工具，本文整理Gitlab部署过程，方便未来查阅。</p><h2 id="0-初始化机器"><a href="#0-初始化机器" class="headerlink" title="0 初始化机器"></a>0 初始化机器</h2><p>推荐RAM 8GB以上。</p><h2 id="1-增加至少4GB-swap"><a href="#1-增加至少4GB-swap" class="headerlink" title="1 增加至少4GB swap"></a>1 增加至少4GB swap</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 创建swap</span><br>dd <span class="hljs-keyword">if</span>=/dev/zero of=/swapfile bs=4M count=1024<br>chmod 600 /swapfile<br>mkswap /swapfile<br>swapon /swapfile<br><br><span class="hljs-comment"># 查看swap状态</span><br>swapon -s <br><br><span class="hljs-comment"># 自动挂载</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;/swapfile none swap sw 0 0&#x27;</span> &gt;&gt; /etc/fstab<br></code></pre></td></tr></table></figure><h2 id="2-挂载数据盘，建议nfsv4"><a href="#2-挂载数据盘，建议nfsv4" class="headerlink" title="2 挂载数据盘，建议nfsv4"></a>2 挂载数据盘，建议nfsv4</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo mount -t nfs -o vers=4.0,noresvport 10.0.0.1:/ /gitlabdata<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;10.0.0.1:/  /gitlabdata  nfs  vers=4.0,noresvport  0  0&#x27;</span> &gt;&gt; /etc/fstab<br></code></pre></td></tr></table></figure><h2 id="3-修改ssh端口号，防止端口冲突"><a href="#3-修改ssh端口号，防止端口冲突" class="headerlink" title="3 修改ssh端口号，防止端口冲突"></a>3 修改ssh端口号，防止端口冲突</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/etc/</span>ssh/sshd_config<br><span class="hljs-comment"># 修改 Port 为 2222，22端口保留给gitlab</span><br><br><span class="hljs-comment"># 重启机器</span><br>reboot <br></code></pre></td></tr></table></figure><h2 id="4-docker跑gitlab-ce"><a href="#4-docker跑gitlab-ce" class="headerlink" title="4 docker跑gitlab-ce"></a>4 docker跑gitlab-ce</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">GITLAB_HOME=<span class="hljs-string">&quot;/gitlabdata&quot;</span><br>docker run --detach --hostname git.xxx.com  \<br>    --env GITLAB_OMNIBUS_CONFIG=<span class="hljs-string">&quot;external_url &#x27;http://git.xxx.com&#x27;&quot;</span> \       <span class="hljs-comment"># 自定义域名，指向本机器</span><br>    --env TZ=<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>   -v /etc/localtime:/etc/localtime  \<br>    --publish 443:443 --publish 80:80 --publish 22:22 --publish 5050:5050 \<br>    --name gitlab   --restart always   --volume <span class="hljs-variable">$GITLAB_HOME</span>/config:/etc/gitlab:Z   \<br>    --volume <span class="hljs-variable">$GITLAB_HOME</span>/logs:/var/<span class="hljs-built_in">log</span>/gitlab:Z   --volume <span class="hljs-variable">$GITLAB_HOME</span>/data:/var/opt/gitlab:Z   \<br>    --shm-size 1024m   gitlab/gitlab-ce:17.2.1-ce.0<br><br><span class="hljs-comment"># 初始化完成后</span><br><span class="hljs-comment"># 查看root密码</span><br>docker <span class="hljs-built_in">exec</span> -it gitlab grep <span class="hljs-string">&#x27;Password:&#x27;</span> /etc/gitlab/initial_root_password<br></code></pre></td></tr></table></figure><h2 id="5-开启ssl"><a href="#5-开启ssl" class="headerlink" title="5 开启ssl"></a>5 开启ssl</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 使用let<span class="hljs-string">&#x27;s encrypt签证书</span><br><span class="hljs-string">vi /gitlabdata/gitlab/config/gitlab.rb</span><br><span class="hljs-string"></span><br><span class="hljs-string">#修改 external_url 为 htts://xxx.xxx.com 自定义域名</span><br><span class="hljs-string">#letsencrypt[&#x27;</span>enabl<span class="hljs-string">e&#x27;] = true</span><br><span class="hljs-string">#letsencrypt[&#x27;</span>auto_renew<span class="hljs-string">&#x27;] = true</span><br><span class="hljs-string">#letsencrypt[&#x27;</span>auto_renew_hour<span class="hljs-string">&#x27;] = 120</span><br><span class="hljs-string"></span><br><span class="hljs-string">应用配置</span><br><span class="hljs-string">docker exec -t gitlab gitlab-ctl reconfigure</span><br></code></pre></td></tr></table></figure><h2 id="5-配置container-registry"><a href="#5-配置container-registry" class="headerlink" title="5 配置container registry"></a>5 配置container registry</h2><p>配置CR域名指向gitlab机器，修改配置。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">registry_external_url <span class="hljs-string">&#x27;https://gcr.xxx.xxx&#x27;</span><br>gitlab_rails[registry_enabl<span class="hljs-string">e&#x27;] = true</span><br><span class="hljs-string">gitlab_rails[registry_host&#x27;</span>] = <span class="hljs-string">&#x27;gcr.xxx.xxx&#x27;</span><br>gitlab_rails[registry_port<span class="hljs-string">&#x27;] = 443</span><br></code></pre></td></tr></table></figure><p>应用配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -t gitlab gitlab-ctl reconfigure<br></code></pre></td></tr></table></figure><h2 id="完结"><a href="#完结" class="headerlink" title="完结"></a>完结</h2><p>至此，Gitlab部署完成。</p>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8s Prometheus</title>
    <link href="/2024/04/11/2024-04-11-k8s-prome/"/>
    <url>/2024/04/11/2024-04-11-k8s-prome/</url>
    
    <content type="html"><![CDATA[<p>记录&amp;分享K8s Gitlab Prometheus搭建过程。</p><span id="more"></span><p>Helm使k8s基建部署变成一件很容易的事。</p><h2 id="1-helm安装"><a href="#1-helm安装" class="headerlink" title="1 helm安装"></a>1 helm安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span><br><span class="hljs-meta">$</span><span class="bash"> helm repo update</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">$</span><span class="bash"> k create ns prome</span><br><span class="hljs-meta">$</span><span class="bash"> helm install -n prome prome -f prom-values.yaml prometheus-community/prometheus</span><br></code></pre></td></tr></table></figure><p>参考values.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">persistentVolume:</span><br>    <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">gp2</span>   <span class="hljs-comment"># eks</span><br>    <span class="hljs-attr">size:</span> <span class="hljs-string">40Gi</span><br>  <span class="hljs-attr">statefulSet:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 方便扩容</span><br></code></pre></td></tr></table></figure><h2 id="2-验证"><a href="#2-验证" class="headerlink" title="2 验证"></a>2 验证</h2><p>pod metadata 增加annotations，自动采集指标。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">prometheus.io/path:</span> <span class="hljs-string">/metrics</span><br>        <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;6000&quot;</span><br>        <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p>登录grafana，配置promethues源，查看指标。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus">prometheus charts</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EKS部署显卡集群</title>
    <link href="/2024/04/09/2024-04-09-eks-gpu-node-group/"/>
    <url>/2024/04/09/2024-04-09-eks-gpu-node-group/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>部署共享GPU集群，加速AI应用计算。</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="1-创建还GPU的node-group"><a href="#1-创建还GPU的node-group" class="headerlink" title="1 创建还GPU的node-group"></a>1 创建还GPU的node-group</h3><p>AMI选择AL2_x86_64_GPU，自带显卡需要，省去手动安装步骤。<br>建议选择nvidia显卡机器。<br>节点打上tag: <code>eks-node=gpu</code>，后面安装驱动用。</p><h3 id="2-helm安装-nvidia-device-plugin"><a href="#2-helm安装-nvidia-device-plugin" class="headerlink" title="2 helm安装 nvidia-device-plugin"></a>2 helm安装 nvidia-device-plugin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><br>helm repo add nvdp https://nvidia.github.io/k8s-device-plugin<br>helm repo update<br><br>helm upgrade -i nvdp nvdp/nvidia-device-plugin \<br>  --namespace nvidia-device-plugin \<br>  -f nvdia-plugin-values.yaml \<br>  --create-namespace \<br>  --version 0.14.5<br></code></pre></td></tr></table></figure><p>nvdia-plugin-values.yaml示例，选择带显卡机器。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">nodeSelector: <br>  eks-<span class="hljs-keyword">node</span><span class="hljs-title">: gpu</span><br></code></pre></td></tr></table></figure><h3 id="3-验证安装"><a href="#3-验证安装" class="headerlink" title="3 验证安装"></a>3 验证安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> cat &lt;&lt;<span class="hljs-string">EOF | kubectl apply -f -</span></span><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: gpu-pod<br>spec:<br>  restartPolicy: Never<br>  containers:<br>    - name: cuda-container<br>      image: nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2<br>      resources:<br>        limits:<br>          nvidia.com/gpu: 1 # requesting 1 GPU<br>  tolerations:<br>  - key: nvidia.com/gpu<br>    operator: Exists<br>    effect: NoSchedule<br>EOF<br><span class="hljs-meta"></span><br><span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> k logs gpu-pod</span></span><br><br></code></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/">https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/</a></li><li><a href="https://github.com/NVIDIA/k8s-device-plugin#quick-start">https://github.com/NVIDIA/k8s-device-plugin#quick-start</a></li><li><a href="https://aws.amazon.com/blogs/containers/gpu-sharing-on-amazon-eks-with-nvidia-time-slicing-and-accelerated-ec2-instances/">https://aws.amazon.com/blogs/containers/gpu-sharing-on-amazon-eks-with-nvidia-time-slicing-and-accelerated-ec2-instances/</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用Win作为开发环境</title>
    <link href="/2024/02/07/2024-02-07-win-dev/"/>
    <url>/2024/02/07/2024-02-07-win-dev/</url>
    
    <content type="html"><![CDATA[<p>使用macos/linux作为开发环境已经有近10年了。最近换电脑，看着新款macbook pro m3有点反向升级。<br>考虑到，一方面最近大公司发力AI，据说2024年即将发布win12对AI整合不错，另一方面如果win实在使用不习惯，可以装linux或黑苹果，所以索性换成win x86笔记本。<br>下面记录使用win11作为开发环境，遇到的问题和解决方案。</p><span id="more"></span><h2 id="1-使用cmder作为默认命令行"><a href="#1-使用cmder作为默认命令行" class="headerlink" title="1 使用cmder作为默认命令行"></a>1 使用cmder作为默认命令行</h2><p>win的官方命令行是powershell。<br>虽然powershell很强大，但我更习惯bash。<br>试了一些终端工具，最顺手的是cmder。</p><p>可以配置页面设置bash为默认shell，并配置右键打开cmder。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">:: 配置右建菜单打开cmder<br>:: 以管理员打开<br>cmder /register all<br></code></pre></td></tr></table></figure><h2 id="2-win11右键默认显示更多选项"><a href="#2-win11右键默认显示更多选项" class="headerlink" title="2 win11右键默认显示更多选项"></a>2 win11右键默认显示更多选项</h2><p>增加cmder右键选项后，发现win11右键不默认不显示“更多选项”，需要改成win10风格右键菜单，方便操作。</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">reg.exe add &quot;HKCU\Software\Classes\CLSID\&#123;<span class="hljs-number">86</span>ca1aa0-<span class="hljs-number">34</span>aa-<span class="hljs-number">4</span>e8b-a509-<span class="hljs-number">50</span>c905bae2a2&#125;\InprocServer32&quot; /f /ve<br></code></pre></td></tr></table></figure><h2 id="3-配置idea-vscode默认使用bash-shell"><a href="#3-配置idea-vscode默认使用bash-shell" class="headerlink" title="3 配置idea/vscode默认使用bash-shell"></a>3 配置idea/vscode默认使用bash-shell</h2><p>cmder带了bash，可以整合到idea/vscode中。</p><p>编写启动脚本，放到PATH目录下，比如我使用<code>%%USERPROFILE%\bin</code>。</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bat">:: bash.bat<br>@<span class="hljs-built_in">echo</span> off<br><span class="hljs-built_in">set</span> CMDER_ROOT=C:\opt\cmder<br><br><span class="hljs-variable">%CMDER_ROOT%</span>\vendor\git-<span class="hljs-keyword">for</span>-windows\bin\bash.exe --login -i<br></code></pre></td></tr></table></figure><p>分别在idea/vscode配置启动shell命令即可。</p><h2 id="4-vscode识别git-exe"><a href="#4-vscode识别git-exe" class="headerlink" title="4 vscode识别git.exe"></a>4 vscode识别git.exe</h2><p>cmder带了git.exe，不需要额外安装。可以将<code>C:\opt\cmder\vendor\git-for-windows\bin</code>加入PATH，重启电脑。</p><h2 id="5-git自动换行符"><a href="#5-git自动换行符" class="headerlink" title="5 git自动换行符"></a>5 git自动换行符</h2><p>不同OS换行符不同。macos/linux一般使用LF，面win使用CRLF，可以配置如下。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># clone里保持换行符，commit时替换成LF（linux格式）</span><br>git config --global core.autocrlf input<br>git config --global core.safecrlf warn<br><br><span class="hljs-comment"># 默认分支名main</span><br>git config --global init.defaultBranch main<br></code></pre></td></tr></table></figure><h2 id="6-包管理器chocolatey和gnu-make"><a href="#6-包管理器chocolatey和gnu-make" class="headerlink" title="6 包管理器chocolatey和gnu make"></a>6 包管理器chocolatey和gnu make</h2><p>我需要使用make管理构建脚本，git-bash默认不带make，需要手动安装。</p><p>这里使用<a href="https://chocolatey.org/install">chocolatey</a>包管理器来安装GNU工具。</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bat">:: 以管理员开启powershell<br>:: 设置policy<br><span class="hljs-built_in">Set</span>-ExecutionPolicy Bypass -Scope Process<br><br>:: 安装 chocolatey<br><span class="hljs-built_in">Set</span>-ExecutionPolicy Bypass -Scope Process -Force; [System.<span class="hljs-built_in">Net</span>.ServicePointManager]::SecurityProtocol = [System.<span class="hljs-built_in">Net</span>.ServicePointManager]::SecurityProtocol -bor <span class="hljs-number">3072</span>; iex ((New-Object System.<span class="hljs-built_in">Net</span>.WebClient).DownloadString(&#x27;https://community.chocolatey.org/install.ps1&#x27;))<br></code></pre></td></tr></table></figure><p>以管理员角色重启powershell，再安装make</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">choco.<span class="hljs-keyword">exe</span> install <span class="hljs-keyword">make</span><br></code></pre></td></tr></table></figure><h2 id="7-安装PowerToys"><a href="#7-安装PowerToys" class="headerlink" title="7 安装PowerToys"></a>7 安装PowerToys</h2><p>PowerToys是Microsoft官方开发工具集，很实用。<br>可以MS Store应用里直接安装。</p>]]></content>
    
    
    
    <tags>
      
      <tag>dev</tag>
      
      <tag>note</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8s Traefik Ingress</title>
    <link href="/2024/02/01/2024-02-01-k8s-traefik-ingress/"/>
    <url>/2024/02/01/2024-02-01-k8s-traefik-ingress/</url>
    
    <content type="html"><![CDATA[<p>Traefik是K8s Ingress的一种方案，支持丰富的中间件扩展方案。</p><span id="more"></span><h2 id="1-helm-安装traefik"><a href="#1-helm-安装traefik" class="headerlink" title="1 helm 安装traefik"></a>1 helm 安装traefik</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl create ns traefik<br>helm repo add traefik https://traefik.github.io/charts<br>helm repo update<br><span class="hljs-comment"># 生产环境建议使用DaemonSet部署</span><br>helm install -n traefik traefik traefik/traefik --<span class="hljs-built_in">set</span> deployment.kind=DaemonSet <br></code></pre></td></tr></table></figure><h2 id="2-配置LB"><a href="#2-配置LB" class="headerlink" title="2 配置LB"></a>2 配置LB</h2><p>查看<strong>EXTERNAL-IP</strong>，并配置domain解析到LB地址。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl get service -n traefik<br></code></pre></td></tr></table></figure><h2 id="3-查看dashboard状态"><a href="#3-查看dashboard状态" class="headerlink" title="3 查看dashboard状态"></a>3 查看dashboard状态</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 访问 http://localhost:9000/dashboard/</span><br>kubectl -n traefik port-forward traefik-XXXX 9000:9000<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8s日志收集Loki</title>
    <link href="/2024/01/30/2024-01-30-k8s-log-collection-loki/"/>
    <url>/2024/01/30/2024-01-30-k8s-log-collection-loki/</url>
    
    <content type="html"><![CDATA[<p>主流的K8s日志收集方案ELK需要部署es集群，很重，需要的机器资源比我们运行服务的机器还多。<br>调研发现轻量级日志方案<a href="https://grafana.com/oss/loki/">loki</a>，正好满足我们需求。</p><span id="more"></span><h2 id="1-Helm安装loki"><a href="#1-Helm安装loki" class="headerlink" title="1 Helm安装loki"></a>1 Helm安装loki</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kubectl create ns loki<br>helm repo add grafana https:<span class="hljs-comment">//grafana.github.io/helm-charts</span><br># <span class="hljs-number">8.5</span><span class="hljs-number">.13</span>修复 chrome bom字符bug<br>helm upgrade --install loki --<span class="hljs-keyword">namespace</span>=loki grafana/loki-stack  --set grafana.enabled=<span class="hljs-literal">true</span> --set grafana.image.tag=<span class="hljs-number">8.5</span><span class="hljs-number">.13</span> <br><br></code></pre></td></tr></table></figure><h2 id="2-部署Ingress暴露访问"><a href="#2-部署Ingress暴露访问" class="headerlink" title="2 部署Ingress暴露访问"></a>2 部署Ingress暴露访问</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl -n loki apply -f ingress.yaml<br><br><span class="hljs-comment"># 查看密码; 使用 admin + 密码登录</span><br>kubectl <span class="hljs-builtin-name">get</span><span class="hljs-built_in"> secret </span>--namespace loki loki-grafana -o <span class="hljs-attribute">jsonpath</span>=<span class="hljs-string">&quot;&#123;.data.admin-password&#125;&quot;</span> | base64 --decode<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ingress.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">loki-grafana-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">loki-grafana.XXX.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">service:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">loki-grafana</span><br>            <span class="hljs-attr">port:</span> <br>              <span class="hljs-attr">name:</span> <span class="hljs-string">service</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">loki-grafana.XXX.com</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">loki-grafana-XXX-tls</span><br></code></pre></td></tr></table></figure><h2 id="3-挂载硬盘持久化日志"><a href="#3-挂载硬盘持久化日志" class="headerlink" title="3 挂载硬盘持久化日志"></a>3 挂载硬盘持久化日志</h2><p>loki提供多种<a href="https://grafana.com/docs/loki/latest/operations/storage/">持久化方案</a>，但最直接的是硬盘。我们使用挂载硬盘方式。</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 查看配置</span><br>kubectl -n loki <span class="hljs-keyword">get</span> statefulsets.apps loki -o yaml<br><br><span class="hljs-meta"># 修改 `storage` volumeClaimTemplates后重新创建</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># demo statefulsets</span><br><span class="hljs-comment"># 更新 2024-09-03 如果单实例的话，建议使用nfs挂载</span><br><span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">storage</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&quot;gp2&quot;</span><br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br></code></pre></td></tr></table></figure><h2 id="4-修改日志保存时间"><a href="#4-修改日志保存时间" class="headerlink" title="4 修改日志保存时间"></a>4 修改日志保存时间</h2><p>loki配置记录在loki secrets，可以改成configmap并修改配置</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><span class="hljs-comment"># 查看并提取日志</span><br>kubectl get secrets loki -n loki -o <span class="hljs-string">&quot;jsonpath=&#123;.data[&#x27;loki\.yaml&#x27;]&#125;&quot;</span> |<span class="hljs-string"> base64 -d </span>|<span class="hljs-string"> tee loki.yaml</span><br></code></pre></td></tr></table></figure><p>修改保存时间</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">table_manager:</span><br>  <span class="hljs-attr">retention_deletes_enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">retention_period:</span> <span class="hljs-string">168h</span>    <span class="hljs-string">//需要24h的整数倍</span><br></code></pre></td></tr></table></figure><p>创建configmap</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">kubectl <span class="hljs-meta">create</span> cm -n loki loki-conf --<span class="hljs-meta">from</span>-<span class="hljs-meta">file</span>=loki.yaml=loki.yml<br></code></pre></td></tr></table></figure><p>更新loki statefulsets，读configmap配置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl -n loki <span class="hljs-builtin-name">edit</span> statefulsets loki<br></code></pre></td></tr></table></figure><p>等待服务更新完成，至此Loki部署完成。</p><h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ul><li><a href="https://aws.amazon.com/cn/blogs/china/from-elk-efk-to-plg-implement-in-eks-a-container-logging-solution-based-on-promtail-loki-grafana/">从ELK/EFK到PLG – 在EKS中实现基于Promtail + Loki + Grafana容器日志解决方案</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8s Gitlab CI/CD</title>
    <link href="/2024/01/29/2024-01-29-k8s-gitlab-cicd/"/>
    <url>/2024/01/29/2024-01-29-k8s-gitlab-cicd/</url>
    
    <content type="html"><![CDATA[<p>记录&amp;分享K8s Gitlab CI/CD搭建过程。</p><span id="more"></span><h2 id="1-helm安装gitlab-runner"><a href="#1-helm安装gitlab-runner" class="headerlink" title="1 helm安装gitlab runner"></a>1 helm安装gitlab runner</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">helm repo add gitlab https://charts.gitlab.io<br>helm repo update gitlab<br>kubectl create ns gitlab<br>helm install -n gitlab -f values.yaml gitlab-runner gitlab/gitlab-runner<br></code></pre></td></tr></table></figure><p>values.yaml参考</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># values.yaml</span><br><span class="hljs-attr">runners:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [[runners]]</span><br><span class="hljs-string">      [runners.kubernetes]</span><br><span class="hljs-string">        # Run all containers with the privileged flag enabled.</span><br><span class="hljs-string">        # See https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerskubernetes-section for details.</span><br><span class="hljs-string">        image = &quot;goland:1.21&quot;</span><br><span class="hljs-string">        service_account = &quot;gitlab-runner&quot;   # 指定sa运行job</span><br><span class="hljs-string">        privileged = true</span><br><span class="hljs-string"></span><span class="hljs-attr">rbac:</span><br>  <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">gitlabUrl:</span> <span class="hljs-string">URL</span><br><span class="hljs-attr">runnerToken:</span> <span class="hljs-string">TOKEN</span><br></code></pre></td></tr></table></figure><h2 id="2-授权gitlab-runner用户修改deployment权限，用于更新服务"><a href="#2-授权gitlab-runner用户修改deployment权限，用于更新服务" class="headerlink" title="2 授权gitlab-runner用户修改deployment权限，用于更新服务"></a>2 授权gitlab-runner用户修改deployment权限，用于更新服务</h2><p>我们gitlab-runner跑在测试集群上，直接授权ClusterRole。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dp-role</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;extensions&quot;</span>, <span class="hljs-string">&quot;apps&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;deployments&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dp-role-binding</span><br><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dp-role</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;gitlab-runner&quot;</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">gitlab</span><br></code></pre></td></tr></table></figure><h2 id="3-在job里直接用bitnami-kubectl镜像更新服务"><a href="#3-在job里直接用bitnami-kubectl镜像更新服务" class="headerlink" title="3 在job里直接用bitnami/kubectl镜像更新服务"></a>3 在job里直接用<code>bitnami/kubectl</code>镜像更新服务</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># .gitlab-ci.yaml</span><br><span class="hljs-attr">upgrade-service:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">deploy</span><br>  <span class="hljs-attr">image:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">bitnami/kubectl:1.28</span><br>    <span class="hljs-attr">entrypoint:</span> [ <span class="hljs-string">&quot;&quot;</span> ]<br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">-n</span> <span class="hljs-string">default</span> <span class="hljs-string">set</span> <span class="hljs-string">image</span> <span class="hljs-string">deployment</span> <span class="hljs-string">XXX</span> <span class="hljs-string">XXX=IMAGE:VERSION</span><br></code></pre></td></tr></table></figure><h2 id="4-跨集群更新服务"><a href="#4-跨集群更新服务" class="headerlink" title="4 跨集群更新服务"></a>4 跨集群更新服务</h2><p>使用vault或env保存kubectl配置，使用<code>bitnami/kubectl</code>调用。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># .gitlab-ci.yaml</span><br><span class="hljs-attr">upgrade-service:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">deploy</span><br>  <span class="hljs-attr">image:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">bitnami/kubectl:1.28</span><br>    <span class="hljs-attr">entrypoint:</span> [ <span class="hljs-string">&quot;&quot;</span> ]<br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">$K8S_CONF|base64</span> <span class="hljs-string">-d</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">/.kube/config</span> <span class="hljs-comment"># env保存配置</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">-n</span> <span class="hljs-string">default</span> <span class="hljs-string">set</span> <span class="hljs-string">image</span> <span class="hljs-string">deployment</span> <span class="hljs-string">XXX</span> <span class="hljs-string">XXX=IMAGE:VERSION</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何从零构建一个系统？</title>
    <link href="/2023/02/06/2023-02-06-how-to-build-a-system-from-scratch/"/>
    <url>/2023/02/06/2023-02-06-how-to-build-a-system-from-scratch/</url>
    
    <content type="html"><![CDATA[<p>曾多次参与系统的从0到1构建工作，这里分享些经验总结：如何开始呢？</p><span id="more"></span><h2 id="1-定义系统边界"><a href="#1-定义系统边界" class="headerlink" title="1 定义系统边界"></a>1 定义系统边界</h2><p>梳理系统的相关方：谁使用这个系统、谁从这个系统受益、谁为这个系统埋单…，明确各方对系统的要求。确定系统能力边界，清楚哪些功能不做，哪些功能应该做。</p><p>该过程可以使用<strong>用例图</strong>描述系统，方便沟通。</p><h2 id="2-分析划分业务模块"><a href="#2-分析划分业务模块" class="headerlink" title="2 分析划分业务模块"></a>2 分析划分业务模块</h2><p>分析业务逻辑，划分出相应模块。借助<strong>方块架构图</strong>描述模块依赖关系，<strong>时序图</strong>描述不同业务场景下模块调用关系，可以帮助分析模块拆分合理性。</p><p><strong>架构图</strong>和<strong>时序图</strong>是沟通工具，用来帮助我们快速聚焦问题，架构可视化，不是目标产物。不要为了画图而画图。</p><h2 id="3-细化模块接口设计"><a href="#3-细化模块接口设计" class="headerlink" title="3 细化模块接口设计"></a>3 细化模块接口设计</h2><p>经过<strong>步骤2</strong>，对系统模块划分和依赖关系已经有较清晰且一致的认识，下一步就是细化接口设计，输出接口文档。接口文档可以使用伪代码，或者某种与实现技术无关的文档，比如proto3、swagger。</p><p>我经验是，过早的技术选型很容易踩坑。技术选型一旦确定，很难更改。随着对系统的深入理解，早期拍脑袋决定的技术选型可能不再合适。应该尽量延迟技术选型：采用什么编程语言、什么框架、什么协议、什么存储引擎…</p><h2 id="4-分模块实现设计"><a href="#4-分模块实现设计" class="headerlink" title="4 分模块实现设计"></a>4 分模块实现设计</h2><p>清楚模块职责和接口后，可以考虑模块实现设计。考虑技术选型、存储模型、算法设计等。<br>好的设计应该是可测的，应该把可测性作为一个指标加入设计中。</p><h2 id="5-跑起来，验证"><a href="#5-跑起来，验证" class="headerlink" title="5 跑起来，验证"></a>5 跑起来，验证</h2><p>最好一步，把分模块实现好的系统组合并跑起来。验证各项功能和性能指标，调整优化。</p>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go测试示例</title>
    <link href="/2023/01/03/2023-01-03-go-test-example/"/>
    <url>/2023/01/03/2023-01-03-go-test-example/</url>
    
    <content type="html"><![CDATA[<p>这篇文章的目的，是分类汇总Go测试示例。当你准备编写代码测试时，可以作为参考。</p><span id="more"></span><h2 id="工具方法测试"><a href="#工具方法测试" class="headerlink" title="工具方法测试"></a>工具方法测试</h2><p>目的：测试工具包、静态方法功能和边界条件。<br>如何编写： 使用<a href="https://github.com/cweill/gotests">gotests</a>，或者IDE自动生成。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPartitionBy</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">type</span> args <span class="hljs-keyword">struct</span> &#123;<br>vs   <span class="hljs-keyword">interface</span>&#123;&#125;<br>size <span class="hljs-keyword">int</span><br>&#125;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>args args<br>want <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;&#123;<br>&#123;<span class="hljs-string">&quot;empty slice&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;&#125;, <span class="hljs-number">1</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#125;&#125;,<br>&#123;<span class="hljs-string">&quot;by 1&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;, <span class="hljs-number">1</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">1</span>&#125;, &#123;<span class="hljs-number">2</span>&#125;, &#123;<span class="hljs-number">3</span>&#125;&#125;&#125;,<br>&#123;<span class="hljs-string">&quot;by 2&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;, <span class="hljs-number">2</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;, &#123;<span class="hljs-number">3</span>&#125;&#125;&#125;,<br>&#123;<span class="hljs-string">&quot;by 3&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;, <span class="hljs-number">3</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;&#125;,<br>&#123;<span class="hljs-string">&quot;by 4&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;, <span class="hljs-number">4</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;&#125;,<br>&#123;<span class="hljs-string">&quot;by 5&quot;</span>, args&#123;[]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;, <span class="hljs-number">5</span>&#125;, [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := PartitionBy(tt.args.vs, tt.args.size); !reflect.DeepEqual(got, tt.want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;PartitionBy() = %v, want %v&quot;</span>, got, tt.want)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br><span class="hljs-comment">// PartitionBy 对slice按size分区</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PartitionBy</span><span class="hljs-params">(vs <span class="hljs-keyword">interface</span>&#123;&#125;, size <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">if</span> size &lt; <span class="hljs-number">1</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;illegal size&quot;</span>)<br>&#125;<br>t := reflect.TypeOf(vs)<br><span class="hljs-keyword">if</span> t.Kind() != reflect.Slice &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;typ should be slice&quot;</span>)<br>&#125;<br><br>v := reflect.ValueOf(vs)<br>vlen := v.Len()<br>length := (vlen + size - <span class="hljs-number">1</span>) / size<br><br>resultValue := reflect.MakeSlice(reflect.SliceOf(t), length, length)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; length; i++ &#123;<br>begin := i * size<br>end := begin + size<br><span class="hljs-keyword">if</span> end &gt; vlen &#123;<br>end = vlen<br>&#125;<br>resultValue.Index(i).Set(v.Slice(begin, end))<br>&#125;<br><br><span class="hljs-keyword">return</span> resultValue.Interface()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="属性测试"><a href="#属性测试" class="headerlink" title="属性测试"></a>属性测试</h2><p>属性测试源于<strong>函数式编程</strong>，是一种更严格的工具包/静态方法测试，用于断言方法的某种与参数无关的属性约束。<br>Go属性测试可以参考： <a href="https://learnku.com/docs/learn-go-with-tests/intro-to-property-based-tests/6145">https://learnku.com/docs/learn-go-with-tests/intro-to-property-based-tests/6145</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestBase64EncodeDecodeSpec</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>   <span class="hljs-comment">//base64加解密后，数据相同</span><br>   assertion := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(src []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>      s := base64.StdEncoding.EncodeToString(src)<br>      got, err := base64.StdEncoding.DecodeString(s)<br>      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>      &#125;<br><br>      <span class="hljs-keyword">return</span> reflect.DeepEqual(src, got)<br>   &#125;<br><br>   <span class="hljs-keyword">if</span> err := quick.Check(assertion, &amp;quick.Config&#123;<br>      MaxCount: <span class="hljs-number">2000</span>,<br>   &#125;); err != <span class="hljs-literal">nil</span> &#123;<br>      t.Error(err)<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Suite-Test"><a href="#Suite-Test" class="headerlink" title="Suite Test"></a>Suite Test</h2><p>一个 Suite由Setup（初始化）、Test（测试）、TearDown（清理）组成，适用于测试对环境有依赖的组件，比如RedisClient、DB ORM等。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RedisClientTestSuite <span class="hljs-keyword">struct</span> &#123;<br>suite.Suite<br><br>client *redis.Client<br>ctx    context.Context<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RedisClientTestSuite)</span> <span class="hljs-title">SetupSuite</span><span class="hljs-params">()</span></span> &#123;<br>addr := <span class="hljs-string">&quot;localhost:6379&quot;</span><br><span class="hljs-keyword">if</span> t := os.Getenv(<span class="hljs-string">&quot;REDIS_ADDR&quot;</span>); t != <span class="hljs-string">&quot;&quot;</span> &#123;<br>addr = t<br>&#125;<br>s.T().Logf(<span class="hljs-string">&quot;load redis addr: %s&quot;</span>, addr)<br><br>rdb := redis.NewClient(&amp;redis.Options&#123;<br>Addr:     addr,<br>Password: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-comment">// no password set</span><br>DB:       <span class="hljs-number">0</span>,  <span class="hljs-comment">// use default DB</span><br>&#125;)<br>ctx := context.Background()<br>_, err := rdb.Ping(ctx).Result()<br>assert.Nil(s.T(), err)<br><br>s.client = rdb<br>s.ctx = ctx<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RedisClientTestSuite)</span> <span class="hljs-title">TestSetAndGet</span><span class="hljs-params">()</span></span> &#123;<br>key := <span class="hljs-string">&quot;xDesTzVCDcN6DCwt&quot;</span><br>val := <span class="hljs-string">&quot;NVGX8fmJJvZt2snR&quot;</span><br>_, err := s.client.Set(s.ctx, key, val, time.Second*<span class="hljs-number">5</span>).Result()<br>assert.Nil(s.T(), err)<br><br>got, err := s.client.Get(s.ctx, key).Result()<br>assert.Nil(s.T(), err)<br>assert.Nil(s.T(), err)<br>assert.Equal(s.T(), val, got)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RedisClientTestSuite)</span> <span class="hljs-title">TestGetNotExistKeyShouldNilErr</span><span class="hljs-params">()</span></span> &#123;<br>_, err := s.client.Get(s.ctx, <span class="hljs-string">&quot;NOT_EXIST&quot;</span>).Result()<br>assert.NotNil(s.T(), err)<br>assert.True(s.T(), errors.Is(err, redis.Nil))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestRedisClientSuite</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>suite.Run(t, <span class="hljs-built_in">new</span>(RedisClientTestSuite))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="服务测试"><a href="#服务测试" class="headerlink" title="服务测试"></a>服务测试</h2><p>服务测试验证服务业务逻辑。服务测试与环境实现无关，可以在不同环境运行。<br>每个服务测试对应一个用户用例，采用 gherkin语法（given-when-then）定义。<br>可用框架：<a href="https://github.com/smartystreets/goconvey/">GoConvey</a>、<a href="https://github.com/onsi/ginkgo">ginkgo</a></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">对于支付，用例描述为<br><span class="hljs-bullet">-</span> case1<br><span class="hljs-bullet">  -</span> Given 用户存在<br><span class="hljs-bullet">  -</span> When 下单<br><span class="hljs-bullet">  -</span> Then 成功生成订单<br><span class="hljs-bullet">-</span> case2<br><span class="hljs-bullet">  -</span> Given 用户已下单<br><span class="hljs-bullet">  -</span> When 收到channel支付回调通知<br><span class="hljs-bullet">  -</span> Then 成功变更订单状态<br><span class="hljs-bullet">  -</span> Then 成功发起发货通知<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
      <tag>测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go纯函数实现Map</title>
    <link href="/2022/12/27/2022-12-27-go-fn-map/"/>
    <url>/2022/12/27/2022-12-27-go-fn-map/</url>
    
    <content type="html"><![CDATA[<p>这是篇水文。</p><p>函数式编程鼓励无状态编程，用函数模拟状态。在编程中，最基础的数据容器是Map，纯函数怎么实现Map呢？</p><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Map <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MapOf</span><span class="hljs-params">(kvs ...<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Map</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i+<span class="hljs-number">1</span> &lt; <span class="hljs-built_in">len</span>(kvs); i += <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">if</span> kvs[i] == key &#123;<br><span class="hljs-keyword">return</span> kvs[i+<span class="hljs-number">1</span>]<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Put</span><span class="hljs-params">(m Map, k, v <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Map</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">if</span> key == k &#123;<br><span class="hljs-keyword">return</span> v<br>&#125;<br><span class="hljs-keyword">return</span> m(k)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Get</span><span class="hljs-params">(m Map, k <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> m(k)<br>&#125;<br></code></pre></td></tr></table></figure><p>来点测试。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestFnMap</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>m := MapOf(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;d&quot;</span>)<br>t.Log(Get(m, <span class="hljs-string">&quot;a&quot;</span>)) <span class="hljs-comment">// =&gt; b</span><br>t.Log(Get(m, <span class="hljs-string">&quot;c&quot;</span>)) <span class="hljs-comment">// =&gt; d</span><br><br>m2 := Put(m, <span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>)<br>t.Log(Get(m2, <span class="hljs-string">&quot;foo&quot;</span>)) <span class="hljs-comment">// =&gt; bar</span><br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式ID生成器</title>
    <link href="/2022/11/29/2022-11-29-id-gen/"/>
    <url>/2022/11/29/2022-11-29-id-gen/</url>
    
    <content type="html"><![CDATA[<p>分布式ID生成器，是分布式系统中最基础的一部分。通过学习分布式ID生成器设计，可以把握分布式系统设计的核心关键。</p><span id="more"></span><h2 id="引子：为什么需要分布式ID生成器？"><a href="#引子：为什么需要分布式ID生成器？" class="headerlink" title="引子：为什么需要分布式ID生成器？"></a>引子：为什么需要分布式ID生成器？</h2><ol><li>大规模数据要求数据分区分库，需要保证业务主键不冲突</li><li>多实例微服务，需要保证产生消息主键不冲突</li><li>用户行为事件，如何保证顺序</li><li>…</li></ol><h2 id="一-常见方案"><a href="#一-常见方案" class="headerlink" title="一 常见方案"></a>一 常见方案</h2><h3 id="1-1-基于UUID"><a href="#1-1-基于UUID" class="headerlink" title="1.1 基于UUID"></a>1.1 基于UUID</h3><p>提到分布式ID，最容易想到的是UUID。UUID可以保证不冲突，但不保证顺序，一般不建议使用。</p><p><strong>优点</strong></p><ul><li>实现简单</li><li>无外部依赖，可本地生成</li></ul><p><strong>缺点</strong></p><ul><li>无序，写入性能差</li><li>基于MAC地址生成UUID的算法可能会造成MAC地址泄露</li><li>空间开销大（这点大部分情况可以忽略）</li></ul><p><strong>如何优化？</strong><br>可以在UUID前拼上时间段，使UUID趋势递增。</p><h3 id="1-2-基于数据库"><a href="#1-2-基于数据库" class="headerlink" title="1.2 基于数据库"></a>1.2 基于数据库</h3><h4 id="1-2-1-自增主键"><a href="#1-2-1-自增主键" class="headerlink" title="1.2.1 自增主键"></a>1.2.1 自增主键</h4><p>数据库的自增主键可以用来做分布式ID，以Mysql为例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> SEQID (<br>    `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> auto_increment, <br>    `<span class="hljs-keyword">value</span>` <span class="hljs-type">char</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (id),<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br></code></pre></td></tr></table></figure><p>获取ID的方式：往SEQID表插入表插入一行记录，获取最新ID。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> SEQID(`<span class="hljs-keyword">value</span>`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;foobar&#x27;</span>);<br><span class="hljs-keyword">SELECT</span> LAST_INSERT_ID();<br></code></pre></td></tr></table></figure><p><strong>优点</strong></p><ul><li>实现简单</li><li>严格单调递增</li></ul><p><strong>缺点</strong></p><ul><li>单库存在性能瓶颈（1e6/s）</li><li>存在单点故障</li><li>需要引入DB依赖</li></ul><h4 id="1-2-2-自增主键-集群模式"><a href="#1-2-2-自增主键-集群模式" class="headerlink" title="1.2.2 自增主键-集群模式"></a>1.2.2 自增主键-集群模式</h4><p>单库作为ID生成器，存在性能瓶颈和单点故障风险。一个简单的优化方式是，引入集群模式，多DB实例发号。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-number">-1</span><br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_offset <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;     <span class="hljs-comment">-- 起始值</span><br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_increment <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;  <span class="hljs-comment">-- 步长</span><br>mysql<span class="hljs-number">-2</span><br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_offset <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;  <br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_increment <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>mysql<span class="hljs-number">-3</span><br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_offset <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;  <br><span class="hljs-keyword">set</span> @<span class="hljs-variable">@auto</span>_increment_increment <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><p><strong>优点</strong></p><ul><li>性能可线性扩展</li><li>具备容灾能力</li></ul><p><strong>缺点</strong></p><ul><li>实现复杂，难维护</li><li>难扩容</li></ul><h4 id="1-2-3-Segment（号段）模式"><a href="#1-2-3-Segment（号段）模式" class="headerlink" title="1.2.3 Segment（号段）模式"></a>1.2.3 Segment（号段）模式</h4><p>以上两种方式，都是使用DB自增主键作为分布式ID。<br>获取ID的流程为</p><ol><li>插入一行记录</li><li>获取并返回记录主键ID</li></ol><p>插入记录需要IO开销，当数据规模增大(1e7/s)，会成为性能瓶颈。<br>一种常见解决方法是，引入号段模式，每次请求发放一组ID，减少IO次数。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> ID_SEGMENT (<br>  id <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  biz_type<span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;业务类型&#x27;</span>,<br>  max_id <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;当前最大id&#x27;</span>,<br>  step <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;号段的步长&#x27;</span>,<br>  `version` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;版本号&#x27;</span>, <br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>);<br></code></pre></td></tr></table></figure><img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjI1MnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MzA2cHg7aGVpZ2h0OjI1MnB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDMwNiAyNTIiIHdpZHRoPSIzMDZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxnPjx0aXRsZT5DbGllbnQ8L3RpdGxlPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIxMDcuMzk4NCIgd2lkdGg9IjgiIHg9IjI4LjI2NTEiIHk9IjY3LjI5NjkiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iMzIiIHgyPSIzMiIgeTE9IjY3LjI5NjkiIHkyPSIxNzQuNjk1MyIvPjwvZz48Zz48dGl0bGU+SURHZW48L3RpdGxlPjxyZWN0IGZpbGw9IiNGRkZGRkYiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIxMDcuMzk4NCIgd2lkdGg9IjgiIHg9IjE5MS4zODA1IiB5PSI2Ny4yOTY5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIgeDE9IjE5NC43NTg0IiB4Mj0iMTk0Ljc1ODQiIHkxPSI2Ny4yOTY5IiB5Mj0iMTc0LjY5NTMiLz48L2c+PGc+PHRpdGxlPkRCPC90aXRsZT48cmVjdCBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTA3LjM5ODQiIHdpZHRoPSI4IiB4PSIyNjcuMzgwNiIgeT0iNjcuMjk2OSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIyNzEuMzgwNiIgeDI9IjI3MS4zODA2IiB5MT0iNjcuMjk2OSIgeTI9IjE3NC42OTUzIi8+PC9nPjxnPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTQuNTMwMyIgeD0iNSIgeT0iMzYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MC41MzAzIiB4PSIxMiIgeT0iNTUuOTk1MSI+Q2xpZW50PC90ZXh0PjwvZz48Zz48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU0LjUzMDMiIHg9IjUiIHk9IjE3My42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDAuNTMwMyIgeD0iMTIiIHk9IjE5My42OTA0Ij5DbGllbnQ8L3RleHQ+PC9nPjxnPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTcuMjQ0MSIgeD0iMTY2Ljc1ODQiIHk9IjM2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDMuMjQ0MSIgeD0iMTczLjc1ODQiIHk9IjU1Ljk5NTEiPklER2VuPC90ZXh0PjwvZz48Zz48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU3LjI0NDEiIHg9IjE2Ni43NTg0IiB5PSIxNzMuNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQzLjI0NDEiIHg9IjE3My43NTg0IiB5PSIxOTMuNjkwNCI+SURHZW48L3RleHQ+PC9nPjxnPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIwLjM4NDgiIHg9IjI1OC4xODgyIiB5PSI2My45OTUxIj5EQjwvdGV4dD48cGF0aCBkPSJNMjUzLjM4MDYsMTUgQzI1My4zODA2LDUgMjcxLjM4MDYsNSAyNzEuMzgwNiw1IEMyNzEuMzgwNiw1IDI4OS4zODA2LDUgMjg5LjM4MDYsMTUgTDI4OS4zODA2LDQxIEMyODkuMzgwNiw1MSAyNzEuMzgwNiw1MSAyNzEuMzgwNiw1MSBDMjcxLjM4MDYsNTEgMjUzLjM4MDYsNTEgMjUzLjM4MDYsNDEgTDI1My4zODA2LDE1ICIgZmlsbD0iI0UyRTJGMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjU7Ii8+PHBhdGggZD0iTTI1My4zODA2LDE1IEMyNTMuMzgwNiwyNSAyNzEuMzgwNiwyNSAyNzEuMzgwNiwyNSBDMjcxLjM4MDYsMjUgMjg5LjM4MDYsMjUgMjg5LjM4MDYsMTUgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS41OyIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMC4zODQ4IiB4PSIyNTguMTg4MiIgeT0iMTg2LjY5MDQiPkRCPC90ZXh0PjxwYXRoIGQ9Ik0yNTMuMzgwNiwxOTkuOTkyMiBDMjUzLjM4MDYsMTg5Ljk5MjIgMjcxLjM4MDYsMTg5Ljk5MjIgMjcxLjM4MDYsMTg5Ljk5MjIgQzI3MS4zODA2LDE4OS45OTIyIDI4OS4zODA2LDE4OS45OTIyIDI4OS4zODA2LDE5OS45OTIyIEwyODkuMzgwNiwyMjUuOTkyMiBDMjg5LjM4MDYsMjM1Ljk5MjIgMjcxLjM4MDYsMjM1Ljk5MjIgMjcxLjM4MDYsMjM1Ljk5MjIgQzI3MS4zODA2LDIzNS45OTIyIDI1My4zODA2LDIzNS45OTIyIDI1My4zODA2LDIyNS45OTIyIEwyNTMuMzgwNiwxOTkuOTkyMiAiIGZpbGw9IiNFMkUyRjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS41OyIvPjxwYXRoIGQ9Ik0yNTMuMzgwNiwxOTkuOTkyMiBDMjUzLjM4MDYsMjA5Ljk5MjIgMjcxLjM4MDYsMjA5Ljk5MjIgMjcxLjM4MDYsMjA5Ljk5MjIgQzI3MS4zODA2LDIwOS45OTIyIDI4OS4zODA2LDIwOS45OTIyIDI4OS4zODA2LDE5OS45OTIyICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuNTsiLz48L2c+PGc+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxODMuMzgwNSw5NC40Mjk3LDE5My4zODA1LDk4LjQyOTcsMTgzLjM4MDUsMTAyLjQyOTcsMTg3LjM4MDUsOTguNDI5NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIzMi4yNjUxIiB4Mj0iMTg5LjM4MDUiIHkxPSI5OC40Mjk3IiB5Mj0iOTguNDI5NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM5Ljg0NDMiIHg9IjM5LjI2NTEiIHk9IjkzLjM2MzgiPiYjMzM3MTk7JiMyMTQ2MjtJRDwvdGV4dD48L2c+PGc+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNTkuMzgwNiwxMjMuNTYyNSwyNjkuMzgwNiwxMjcuNTYyNSwyNTkuMzgwNiwxMzEuNTYyNSwyNjMuMzgwNiwxMjcuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIxOTUuMzgwNSIgeDI9IjI2NS4zODA2IiB5MT0iMTI3LjU2MjUiIHkyPSIxMjcuNTYyNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjIwMi4zODA1IiB5PSIxMjIuNDk2NiI+JiMzMzcxOTsmIzIxNDYyOyYjMjE0OTU7JiMyNzU3Mzs8L3RleHQ+PC9nPjxnPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDMuMjY1MSwxNTIuNjk1MywzMy4yNjUxLDE1Ni42OTUzLDQzLjI2NTEsMTYwLjY5NTMsMzkuMjY1MSwxNTYuNjk1MyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIuMCwyLjA7IiB4MT0iMzcuMjY1MSIgeDI9IjE5NC4zODA1IiB5MT0iMTU2LjY5NTMiIHkyPSIxNTYuNjk1MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS4xMTU0IiB4PSI0OS4yNjUxIiB5PSIxNTEuNjI5NCI+JiMzNjgyMDsmIzIyMjM4O0lEJiM2NTI5MjsmIzIwODY5OyYjMjMzODQ7JiMzNTc2MDsmIzI0NDA1OyYjMzMyNTg7JiMyMjY4NjsxPC90ZXh0PjwvZz48IS0tU1JDPVtBcVdpQWliQ3BZbjhwMmpIU0N4OUpDcWh1SWYwNGw5cVNLX0R1cWY5QjRiQ0lZbkVMTjFudWU4ZUtqMnJXeVhQQVJwZXNfd3FWdmdkMm5VTzN2OW1TT0E5Rmt0Vl9jcFRMZldDSzBnWTZvWXpWeWhKc1ZDeU5UeGx3TmRRcmxmcXhPbU53cE95dEpsckhWa2dmdWxjNkc4MF0tLT48L2c+PC9zdmc+'><p><strong>优点</strong></p><ul><li>解决DB IO性能瓶颈</li></ul><p><strong>缺点</strong></p><ul><li>需要额外引入IDGen服务</li><li>实现稍复杂，难维护</li><li>需要DB依赖</li></ul><h3 id="1-3-Snowflake"><a href="#1-3-Snowflake" class="headerlink" title="1.3 Snowflake"></a>1.3 Snowflake</h3><p>Snowflake是Twitter公司采用的一种算法，使用int64正数部分作为ID。Snowflake及其变种，如<a href="https://www.mongodb.com/docs/manual/reference/method/ObjectId/">MongoDB ObjID</a>，在业内应用较为广泛。</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">+--------------------------------------------------------------------------+</span><br><span class="hljs-section">| 1 Bit Unused | 41 Bit Timestamp |  10 Bit NodeID  |   12 Bit Sequence ID |</span><br><span class="hljs-section">+--------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>组成部分（64bit）</p><ol><li>第一位 占用1bit，其值始终是0，没有实际作用。</li><li>时间戳 占用41bit，精确到毫秒，总共可以容纳约69年的时间。 </li><li>工作机器id 占用10bit，其中高位5bit是数据中心ID，低位5bit是工作节点ID，做多可以容纳1024个节点。 </li><li>序列号 占用12bit，每个节点每毫秒0开始不断累加，最多可以累加到4095，一共可以产生4096个ID。</li></ol><p>Snowflake算法在同一节点毫秒内最多生成的ID数量 = 1024 X 4096 = 4194304</p><p><strong>优点</strong></p><ul><li>毫秒数在高位，自增序列在低位，整个ID都是趋势递增的。</li><li>不依赖数据库等第三方系统，以服务的方式部署，稳定性更高，生成ID的性能也是非常高的。</li><li>可以根据自身业务特性分配bit位，非常灵活。</li></ul><p><strong>缺点</strong></p><ul><li>强依赖机器时钟，如果机器上时钟回拨，会导致发号重复或者服务会处于不可用状态。</li></ul><h3 id="1-4-方案对比"><a href="#1-4-方案对比" class="headerlink" title="1.4 方案对比"></a>1.4 方案对比</h3><table><thead><tr><th>方案</th><th>长度</th><th>趋势递增</th><th>单调递增</th><th>依赖三方组件</th><th>关键缺点</th></tr></thead><tbody><tr><td>UUID</td><td>128bits</td><td>否</td><td>否</td><td>否</td><td>version-1存在暴露MAC地址风险</td></tr><tr><td>DB自增ID</td><td>64bits</td><td>是</td><td>是</td><td>是</td><td>依赖DB，重</td></tr><tr><td>DB集群模式</td><td>64bits</td><td>是</td><td>否</td><td>是</td><td>依赖DB，重</td></tr><tr><td>DB号段模式</td><td>64bits</td><td>是</td><td>否</td><td>是</td><td>依赖DB，重</td></tr><tr><td>Snowflake</td><td>64bits</td><td>是</td><td>否</td><td>否</td><td>存在时间回拨</td></tr></tbody></table><h2 id="二-业界实践"><a href="#二-业界实践" class="headerlink" title="二 业界实践"></a>二 业界实践</h2><p>这一部分分享业内成熟的分布式ID生成器实践。</p><h3 id="2-1-uid-generator-百度"><a href="#2-1-uid-generator-百度" class="headerlink" title="2.1 uid-generator (百度)"></a>2.1 uid-generator (百度)</h3><p><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md">uid-generator</a>基于Snowflake实现，调整位数分配为1-28-22-13，使用秒时间戳。<br>相比Twitter的Snowflake，支持更大规模多实例部署（2^22=4194304）。百度的思路是把uid-generator作为lib整合到服务中，无需独立部署ID生成器服务。</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">+------------------------------------------------------------------------------------+</span><br><span class="hljs-section">| 1 Bit Unused | 28 Bit Timestamp |  22 Bit NodeID(WorkerID)  |   13 Bit Sequence ID |</span><br><span class="hljs-section">+------------------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure><p>使用秒时间戳，同一秒同一节点生成的ID连续分布，容易被扫描攻击。百度的解决思路是引入<strong>双环形缓存</strong>，按一定策略异步生成缓存ID，减少ID连续性。</p><p><img src="/img/baidu-ringbuffer.png"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>百度uid-generator的出发点是<strong>去ID生成器服务</strong>。为此增加ID中的WorkerID位数，减少Timestamp位数，采用秒时间戳，引入缓存机制减少ID连续性，实现较复杂。<br>优点是无需独立部署独立ID生成器服务，建议只在不复杂的单体服务中使用。</p><h3 id="2-2-Leaf（美团点评）"><a href="#2-2-Leaf（美团点评）" class="headerlink" title="2.2 Leaf（美团点评）"></a>2.2 Leaf（美团点评）</h3><p><a href="https://github.com/Meituan-Dianping/Leaf/blob/master/README_CN.md" title="Meituan-Dianping/Leaf">Leaf</a>是美团点评的分布式ID生成系统，提供<strong>segment</strong>和<strong>snowflake</strong>两种模式，分别对DB Segment模式和Snowflake做了优化。</p><h4 id="Leaf-Segment模式"><a href="#Leaf-Segment模式" class="headerlink" title="Leaf-Segment模式"></a>Leaf-Segment模式</h4><p>Leaf-segment模式依赖DB，采用Segment模式。在传统Segment模式实现上加上双buffer优化，解决发号服务某一号段用完，重新申请号段可能引起的请求耗时抖动。</p><img src="/img/leaf-segment.png"><h4 id="Leaf-snowflake模式"><a href="#Leaf-snowflake模式" class="headerlink" title="Leaf-snowflake模式"></a>Leaf-snowflake模式</h4><p>snowflake方案在集群模式下如何保证多实例workerID不冲突？</p><p>Leaf-snowflake模式在snowflake算法基础上引入zk依赖，用zk给每个idgen服务发号，保证workerID不冲突。</p><img src="/img/leaf-snowflake.png"><h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>Leaf是美团优化实现的分布式ID生成器成熟方案，实用性较强。</p><h3 id="2-3-微信seqsvr"><a href="#2-3-微信seqsvr" class="headerlink" title="2.3 微信seqsvr"></a>2.3 微信seqsvr</h3><p>IM场景要求用户消息序号严格单调递增，snowflake无法保证。微信自研并演进出一套序号生成器架构，具有很高参考价值。</p><p>微信使用int64作为ID，每个用户有独立序号空间，每个序号空间序号严格递增。</p><img src="/img/wx-seqsvr-01.webp"><p>类似于DB自增主键方式，为了减少获取ID的IO频率，引入号段max_seq。当seqsvr故障重启，加载max_seq恢复发号。</p><img src="/img/wx-seqsvr-02.webp"><p>每个用户独立8bytes max_seq，在微信亿级用户规模下，存储开销大（以2^32估计，数据大小一共为32GB），故障恢复耗时高。微信的优化方式是，引入用户Section的概念，uid相邻的一段用户属于一个号段，而同个号段内的用户共享一个 max_seq，这样大幅减少了 max_seq 数据的大小，同时也降低了 IO 次数。对用户分段，使多个用户公用同一个max_seq。(实践上，一个Section包含10万个uid)</p><img src="/img/wx-seqsvr-03.webp"><p>工程实现上，将系统分离为中间层和存储层，既方便中间层容灾，也方便存储层扩容。</p><img src="/img/wx-seqsvr-arch.webp"><h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><p>微信ID生成器的架构设计，体现了在复杂工程上把握关键点，保持简单设计的智慧，在工程上有很高参考价值。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leaf——美团点评分布式ID生成系统</a></li><li><a href="https://www.infoq.cn/article/wechat-serial-number-generator-architecture">微信序列号生成器架构设计及演变</a></li><li><a href="https://github.com/Meituan-Dianping/Leaf/blob/master/README_CN.md" title="Meituan-Dianping/Leaf">Meituan-Dianping/Leaf</a></li><li><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md">百度uid-generator</a></li><li><a href="https://github.com/didi/tinyid">滴滴Tinyid</a></li><li><a href="https://www.mongodb.com/docs/manual/reference/method/ObjectId/">MongoDB ObjID</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>设计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go配置热更——动态绑定</title>
    <link href="/2022/11/15/2022-11-15-bind-nacos-config/"/>
    <url>/2022/11/15/2022-11-15-bind-nacos-config/</url>
    
    <content type="html"><![CDATA[<p>当我们使用配置中心时，我们希望配置热更。一般的实现方式是，读取配置初始化并增加变更监听。这种方式可以实现，但需要我们维护配置变更逻辑，不友好。</p><p>在大多数场景下，我们想要的其实是一个<code>func()</code>，每次调用返回最新的结构化配置。Go 1.18增加了泛型，可以很优雅地解决配置热更问题。</p><p>我以nacos为例，写了一个<strong>动态绑定库</strong><a href="https://github.com/a3d21/bind_nacos_cfg">bind_nacos_cfg</a>。</p><p>接口如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Supplier 获取最新配置</span><br><span class="hljs-keyword">type</span> Supplier[T any] <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">T</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sup Supplier[T])</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> <span class="hljs-title">T</span></span> &#123;<br><span class="hljs-keyword">return</span> sup()<br>&#125;<br><br><span class="hljs-comment">// MustBind 绑定某配置项</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MustBind</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(cli config_client.IConfigClient, dataID, group <span class="hljs-keyword">string</span>, typ T)</span> <span class="hljs-title">Supplier</span>[<span class="hljs-title">T</span>]</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>使用Demo</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ConfigStruct <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot; yaml:&quot;name&quot;`</span><br>City <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;city&quot; yaml:&quot;city&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> cli config_client.IConfigClient <span class="hljs-comment">// TODO 初始化</span><br>dataID := <span class="hljs-string">&quot;abc&quot;</span><br>group := <span class="hljs-string">&quot;def&quot;</span><br><span class="hljs-keyword">var</span> GetConf = bind_nacos_cfg.MustBind(cli, dataID, group, &amp;ConfigStruct&#123;&#125;)<br><span class="hljs-comment">// 也支持原生结构类型</span><br><span class="hljs-comment">// var GetConf = bind_nacos_cfg.MustBind(cli, dataID, group, ConfigStruct&#123;&#125;)</span><br><span class="hljs-comment">// var GetConf = bind_nacos_cfg.MustBind(cli, dataID, group, map[string]string&#123;&#125;)</span><br><span class="hljs-comment">// var GetConf = bind_nacos_cfg.MustBind(cli, dataID, group, []string&#123;&#125;)</span><br><span class="hljs-comment">// 绑定并监听变更。考虑到存在需要监听配置做额外操作的场景，增加的可选Listner[T]参数</span><br><span class="hljs-comment">// var GetConf = bind_nacos_cfg.MustBind(cli, dataID, group, &amp;ConfigStruct&#123;&#125;, func(v *ConfigStruct) &#123;</span><br><span class="hljs-comment">//  fmt.Println(v)</span><br><span class="hljs-comment">// &#125;)</span><br><br><span class="hljs-comment">// c.(type) == *ConfigStruct</span><br>c := GetConf() <span class="hljs-comment">// 获取最新配置</span><br>c = GetConf()<br>c = GetConf() <span class="hljs-comment">// 配置变更自动监听更新</span><br><br>fmt.Println(c)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>我折腾过的编程语言</title>
    <link href="/2022/11/13/2022-11-13-programming-langs/"/>
    <url>/2022/11/13/2022-11-13-programming-langs/</url>
    
    <content type="html"><![CDATA[<p>我折腾过的编程语言有</p><table><thead><tr><th>语言</th><th>特点</th><th>说明</th></tr></thead><tbody><tr><td>Go</td><td>简单，静态编译</td><td>最近3年主要工作语言</td></tr><tr><td>Java</td><td>生态成熟</td><td>Go之前主要工作语言，现在偶尔写些业余项目</td></tr><tr><td>Clojure</td><td>数据即代码，元编程</td><td>17年学函数式编程时学的，写过GUI程序和几个Web小项目</td></tr><tr><td>Haskell</td><td>强类型函数式</td><td>17年学函数式编程时学的，主要是开阔眼界</td></tr><tr><td>Kotlin</td><td>加糖版Java，有协程</td><td>写过Demo，无实际项目经验</td></tr><tr><td>Groovy</td><td>动态版本Java</td><td>尝试过在Java项目中混合编程，收益有限</td></tr><tr><td>Python</td><td>库成熟</td><td>经常用来写测试脚本。用它写过爬虫，但发布时依赖处理很麻烦，所以很少在项目中用它</td></tr><tr><td>Scala2</td><td>FP+OOP大成</td><td>提供FP的实际工程解决方案。虽然没深度使用过，但通过学习理解了Monad等概念在工程上的应用</td></tr><tr><td>node.js</td><td>脚本语言，对云友好</td><td>很多云平台支持托管node.js项目，用它写小项目很方便</td></tr><tr><td>Rust</td><td>强类型，内存安全</td><td>18年学Go时了解到，并开始学习的。它完美解决了当时Go的所有痛点：依赖管理、泛型支持、FP支持</td></tr></tbody></table><p>随着编程经验积累，我越来越发现，编程问题的实际难点在于</p><ol><li>对问题的理解与抽象</li><li>对底层原理的理解与应用</li></ol><p>相反，编程语言常常不是那么重要的。如果我理解了EventSourcing，我可以用任意一种语言实现EventSourcing架构。<br>如果让我从零开始实现一个系统，我会优先考虑在该领域生态更成熟的语言。如果是新兴领域，再看语言的抽象能力和领域匹配度。</p><p>但是，如果让我选出最喜欢的语言，我会毫不犹豫地选Clojure。</p><ul><li>Clojure是一门LISP方言，它可以像操作数据一样操作自身代码，构建代码抽象。写LISP是个思考过程，代码越写与自己的想法越契合。做个对比，如果我写Java，我需要将问题解构成<code>Class</code>和<code>Object</code>，可是有些场景（eg: 测试脚本）这套模型未必适合，所以写出的代码难以理解。但如果用LISP，可以按自己的想法任意组织代码，过程就像写文章一样。</li><li>Clojure是一门JVM语言，这意味着它可以方便地用上Java生态，很方便。</li></ul><p>Clojure现在工程应用很少，如果哪天我创业，它也许会成为我的“秘密武器”。</p>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>为什么我不喜欢心理学？</title>
    <link href="/2022/08/13/2022-08-13-why-do-i-hate-psychology/"/>
    <url>/2022/08/13/2022-08-13-why-do-i-hate-psychology/</url>
    
    <content type="html"><![CDATA[<p>本文是我，作为一个非专业人士，对心理学的个人看法，可能存在谬误，欢迎批评指正。</p><span id="more"></span><ol><li>心理学的目的是，解释人的行为，使行为合理化。为此发展出多个的心理学流派，彼此互不相容，但又自圆其说。在我看来，心理学作为一门学科，是分裂的。</li><li>心理学无法解决实际问题，只能提供一种心灵的慰藉。大多数人求诸理学的问题，都是更为实际的问题导致的。如果解决了实际问题，就不存在所谓“心理问题”。心理学对解决实际毫无作用。</li><li>现代人们对心理学的需求，类似于中世纪人们对宗教的需求——企图获得某种心灵慰藉或救赎。 </li><li>喜欢心理学的人喜欢强调“原生家庭”，好像一切不好的事情——自卑、懦弱——都是原生家庭导致的，或者说，都是父母的错。我承认，一个人的经历很重要，会影响一个人的心理；但是将所有问题都归结于别人和不可改变的过去，是件很不负责任的事。人应该正视问题，学习成长，解决问题。将所有问题归结于原生家庭的人都是Loser。</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>随笔</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一道有趣的概率题</title>
    <link href="/2022/05/10/2022-05-10-bayes-question/"/>
    <url>/2022/05/10/2022-05-10-bayes-question/</url>
    
    <content type="html"><![CDATA[<p>最近看到一道有趣的概率题，内容为</p><blockquote><p>两个预言家，一个准确率90%，一个准确率30%，他们都预言了未日降临，那么末日降临的概率是多少呢?</p></blockquote><span id="more"></span><p>我一眼看出这是条件概率题。我把它分享给朋友，几个朋友不熟悉概率论，脑瓜卡壳了（记得是高中知识，可能都忘了）。为了讲清楚“贝叶斯公式”，有了这篇水文。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p><img src="/img/bayes.svg"></p><p><strong>什么是条件概率?</strong><br>假设事件$A$、$B$，我们分别记事件$A$、$B$的概率为: $P(A)$ 、$P(B)$。<br>假如事件存在相关性，在已知事件$B$发生的条件下，$A$也发生的概率是多少呢？我们把它记为$P(A|B)$，称为条件概率。</p><p><strong>什么是贝叶斯公式?</strong><br>贝叶斯公式，也叫贝叶斯定理，用于描述多个<strong>条件概率</strong>之间的关系。</p><p>借助Venn图，可以很容易理解。<br>$$P(A|B) = \frac{P(A \cap B)}{P(B)}$$<br>$$P(A \cap B) = P(A|B)P(B) = P(B|A)P(A) $$</p><h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><p>回到问题。借用Venn图表示<br><img src="/img/doom_venn.svg"><br>$A$对应「世界末日」，$B$对应「两预言家都预言末日降临」，故灾难发生的概率为</p><p>$$<br>P(A|B) = \frac {0.27} {0.27 + 0.07} = 0.794<br>$$</p><h2 id="一点小思考"><a href="#一点小思考" class="headerlink" title="一点小思考"></a>一点小思考</h2><p>值得注意的一点是，如果没有第二位预言家的预言，末日降临的概率为0.9。第二位预言家的预言拉低了概率。<br>这是可以理解的，因为第二们的预言家准确率低，在数学上，相当于70%准确率预言末日不降临。</p><p>把这个模型对应到生活，如果所有人都说股市要涨，大概率要跌 :)。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>GoStream实现BufferChan</title>
    <link href="/2022/01/28/2022-01-28-gostream-buffer-channel/"/>
    <url>/2022/01/28/2022-01-28-gostream-buffer-channel/</url>
    
    <content type="html"><![CDATA[<p>在<a href="/2022/01/27/2022-01-27-go-buffer-channel/">上一篇文章</a>中，我实现了Go BufferChan。但BufferChan作为一个独立库，实际使用上并不方便，所以想着把BufferChan整合进<a href="https://github.com/a3d21/gostream">GoStream</a>中。</p><p>原理是，将<a href="/2022/01/27/2022-01-27-go-buffer-channel/">上一篇文章</a>的实现原理封闭在在GoStream的<code>BufferChan()</code>中。</p><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/// chan.go</span><br><br><span class="hljs-comment">// BufferChan 对channel运行缓存</span><br><span class="hljs-comment">// 当接收消息达到`size`或超过`timeout`未收到新消息时，发送消息</span><br><span class="hljs-comment">// 参数说明</span><br><span class="hljs-comment">//   typ  slice类型参数</span><br><span class="hljs-comment">//   size  缓存数量</span><br><span class="hljs-comment">//   timeout  超时时间</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Stream)</span> <span class="hljs-title">BufferChan</span><span class="hljs-params">(typ <span class="hljs-keyword">interface</span>&#123;&#125;, size <span class="hljs-keyword">int</span>, timeout time.Duration)</span> <span class="hljs-title">Stream</span></span> &#123;<br>t := reflect.TypeOf(typ)<br><span class="hljs-keyword">if</span> t.Kind() != reflect.Slice &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;typ should be slice&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;size should gt 0&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> timeout &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;timeout should gt 0&quot;</span>)<br>&#125;<br><br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br>out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> s.OutChan(in)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>sv := reflect.MakeSlice(t, size, size)<br>idx := <span class="hljs-number">0</span><br><br><span class="hljs-keyword">var</span> brush = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>out &lt;- sv.Slice(<span class="hljs-number">0</span>, idx).Interface()<br>sv = reflect.MakeSlice(t, size, size)<br>idx = <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> v, ok := &lt;-in:<br><span class="hljs-keyword">if</span> ok &#123;<br>sv.Index(idx).Set(reflect.ValueOf(v))<br>idx++<br><span class="hljs-keyword">if</span> idx == size &#123;<br>brush()<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> idx &gt; <span class="hljs-number">0</span> &#123;<br>brush()<br>&#125;<br><span class="hljs-built_in">close</span>(out)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">case</span> &lt;-time.After(timeout):<br><span class="hljs-keyword">if</span> idx &gt; <span class="hljs-number">0</span> &#123;<br>brush()<br>&#125;<br>&#125;<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">return</span> From(out)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>加点测试验证下。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/// chan_test.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestBufferChanBySize</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>in &lt;- i<br>&#125;<br><span class="hljs-built_in">close</span>(in)<br>&#125;()<br><br>want := [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;, &#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;&#125;<br>got := From(in).BufferChan([]<span class="hljs-keyword">int</span>&#123;&#125;, <span class="hljs-number">3</span>, time.Second).Collect(ToSlice([][]<span class="hljs-keyword">int</span>&#123;&#125;))<br>assert.Equal(t, want, got)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestBufferChanByTimeout</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>in &lt;- <span class="hljs-number">0</span><br>time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>in &lt;- <span class="hljs-number">1</span><br>in &lt;- <span class="hljs-number">2</span><br>time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>in &lt;- <span class="hljs-number">3</span><br>in &lt;- <span class="hljs-number">4</span><br><span class="hljs-built_in">close</span>(in)<br>&#125;()<br>want := [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;, &#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;&#125;<br>got := From(in).BufferChan([]<span class="hljs-keyword">int</span>&#123;&#125;, <span class="hljs-number">100</span>, time.Millisecond*<span class="hljs-number">300</span>).Collect(ToSlice([][]<span class="hljs-keyword">int</span>&#123;&#125;))<br>assert.Equal(t, want, got)<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>实现GoChannel缓存——BufferChan</title>
    <link href="/2022/01/27/2022-01-27-go-buffer-channel/"/>
    <url>/2022/01/27/2022-01-27-go-buffer-channel/</url>
    
    <content type="html"><![CDATA[<p>channel 是一种消息通信方式，常用于异步通信。</p><p>在通信过程中，将多个消息按一定<strong>数量</strong>或<strong>时间间隔</strong>缓存起来再批量发送，是一种常见的优化方式。常见的策略是，当消息数达到<code>size</code>或超时<code>timeout</code>未收到消息时触发一次消息。</p><p>Go实现如下。</p><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/// bufferchan.go</span><br><br><span class="hljs-comment">// BufferChan 对channel运行缓存</span><br><span class="hljs-comment">// 当接收消息达到`size`或超过`timeout`未收到新消息时，发送消息</span><br><span class="hljs-comment">// 参数说明</span><br><span class="hljs-comment">//   typ  slice类型参数</span><br><span class="hljs-comment">//   size  缓存数量</span><br><span class="hljs-comment">//   timeout  超时时间</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Stream)</span> <span class="hljs-title">BufferChan</span><span class="hljs-params">(typ <span class="hljs-keyword">interface</span>&#123;&#125;, size <span class="hljs-keyword">int</span>, timeout time.Duration)</span> <span class="hljs-title">Stream</span></span> &#123;<br>t := reflect.TypeOf(typ)<br><span class="hljs-keyword">if</span> t.Kind() != reflect.Slice &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;typ should be slice&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;size should gt 0&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> timeout &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;timeout should gt 0&quot;</span>)<br>&#125;<br><br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br>out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> s.OutChan(in)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>sv := reflect.MakeSlice(t, size, size)<br>idx := <span class="hljs-number">0</span><br><br><span class="hljs-keyword">var</span> flush = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>out &lt;- sv.Slice(<span class="hljs-number">0</span>, idx).Interface()<br>sv = reflect.MakeSlice(t, size, size)<br>idx = <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> v, ok := &lt;-in:<br><span class="hljs-keyword">if</span> ok &#123;<br>sv.Index(idx).Set(reflect.ValueOf(v))<br>idx++<br><span class="hljs-keyword">if</span> idx == size &#123;<br>flush()<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> idx &gt; <span class="hljs-number">0</span> &#123;<br>flush()<br>&#125;<br><span class="hljs-built_in">close</span>(out)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">case</span> &lt;-time.After(timeout):<br><span class="hljs-keyword">if</span> idx &gt; <span class="hljs-number">0</span> &#123;<br>flush()<br>&#125;<br>&#125;<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">return</span> From(out)<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>加一些测试。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/// bufferchan_test.go</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSizeBuffer</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>ctx := context.Background()<br><br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>in &lt;- i<br>&#125;<br>&#125;()<br><br>out := BufferChan(ctx, in, BufferConfig&#123;<br>Size:    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">3</span> &#125;,<br>Timeout: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Duration</span></span> &#123; <span class="hljs-keyword">return</span> time.Second &#125;,<br>&#125;)<br><br>want := []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;,<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;,<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>&#125;,<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">9</span>&#125;&#125;<br><span class="hljs-keyword">var</span> got []<span class="hljs-keyword">interface</span>&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ &#123;<br>got = <span class="hljs-built_in">append</span>(got, &lt;-out)<br>&#125;<br><br><span class="hljs-keyword">if</span> !reflect.DeepEqual(got, want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;%v != %v&quot;</span>, got, want)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestTimeoutBuffer</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>ctx := context.Background()<br><br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>in &lt;- <span class="hljs-number">0</span><br>time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>in &lt;- <span class="hljs-number">1</span><br>in &lt;- <span class="hljs-number">2</span><br>time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>in &lt;- <span class="hljs-number">3</span><br>in &lt;- <span class="hljs-number">4</span><br>in &lt;- <span class="hljs-number">5</span><br>&#125;()<br><br>out := BufferChan(ctx, in, BufferConfig&#123;<br>Size:    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> &#125;,<br>Timeout: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Duration</span></span> &#123; <span class="hljs-keyword">return</span> time.Millisecond * <span class="hljs-number">300</span> &#125;,<br>&#125;)<br><br>want := []<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">0</span>&#125;,<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;,<br>[]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;,<br>&#125;<br><span class="hljs-keyword">var</span> got []<span class="hljs-keyword">interface</span>&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<br>got = <span class="hljs-built_in">append</span>(got, &lt;-out)<br>&#125;<br><br><span class="hljs-keyword">if</span> !reflect.DeepEqual(got, want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;%v != %v&quot;</span>, got, want)<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>并发模型</title>
    <link href="/2022/01/25/2022-01-25-concurrency-model/"/>
    <url>/2022/01/25/2022-01-25-concurrency-model/</url>
    
    <content type="html"><![CDATA[<p>这是一个之前分享过的Slides。</p><span id="more"></span><iframe src="https://hackmd.io/@J19CM3_0SGWcJoNTNSk2MA/SkRwhmTaK" height="600px" width="100%" align="center"></iframe>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何测试服务？——Go DDD实践</title>
    <link href="/2022/01/04/2022-01-04-how-to-test-your-service/"/>
    <url>/2022/01/04/2022-01-04-how-to-test-your-service/</url>
    
    <content type="html"><![CDATA[<p>编写能跑的程序，是编程的最低要求，软件工程的真正难点在于架构和测试。大多数人对测试存在误解。</p><span id="more"></span><blockquote><p>常见误解</p><p><strong>测试是QA团队的事</strong><br>最常见的误解是，测试是QA团队的事。RD只负责编写代码，测试完全由QA负责，无需（或没必要）花太多精力在测试上。事实上，可测试性是架构的一部分，编写可测试的代码对架构提出更严格的要求，需要付出努力才能达到。能否编写可测试代码的衡量一个人软件工程能力的重要标准。</p><p><strong>编写测试影响开发效率</strong><br>项目赶进度，编写测试影响开发效率？大量统计表明，编写测试可以提升开发效率。其中主要原因有两方面：自动化测试可以帮助迭代开发中快速定位异常，缩短定位时间；测试对系统架构提出更严格要求，好的架构更容易迭代。</p><p><strong>单测覆盖面越广越好</strong><br>测试的目的是帮忙我们快速定位异常位置，理想的测试应该是足够精细，以至于当用例报错时，可以直接定位到异常原因。覆盖面太广会使问题难以定位，</p></blockquote><h2 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h2><p>在DDD实践中，我们将系统分层：应用层、领域层、设施层。</p><table><thead><tr><th>层级</th><th>简写</th><th>说明</th></tr></thead><tbody><tr><td>应用层</td><td>Application</td><td>聚合领域服务，并对外提供接口</td></tr><tr><td>领域层</td><td>Domain</td><td>通过领域服务对业务逻辑建模</td></tr><tr><td>设施层</td><td>Infra</td><td>领域服务的设施实现</td></tr></tbody></table><p>在一个DDD系统中，领域层只负责业务逻辑，与具体设施实现无关。事实上，一个领域服务可以有多个不同的设施实现（比如：Infra1使用mysql作为repo实现、Infra2使用mongo）。</p><p>为方便理解，引入记号。 </p><table><thead><tr><th>记号</th><th>说明</th></tr></thead><tbody><tr><td>$D$</td><td>领域服务</td></tr><tr><td>$I$、$I_n$</td><td>设施实现，eg: $I_1$、$I_2$</td></tr></tbody></table><p>$D$和$I$组合成一个具体的领域服务实现——$D\ I_1$、$D\ I_2$。</p><p>对于测试，我们进行分层。</p><table><thead><tr><th>记号</th><th>说明</th></tr></thead><tbody><tr><td>$TD$</td><td>领域层测试。用于验证业务逻辑</td></tr><tr><td>$TI$</td><td>设施层测试。用于保证Infra实现正确</td></tr></tbody></table><p>$TI$类型签名为 $TI :: I \rightarrow ()$，表示接收一个设施实现作为参数，返回测试结果。<br>$TD$类型签名为 $TD :: D \rightarrow I \rightarrow ()$，表示依次接收一个领域服务和设施实现作为参数，返回测试结果。</p><p>这么设计的一个好处是，测试与设施解耦，可自由组合。<br>比如，$TI\ I_1$ 表示对Infra1进行测试、 $TD\ D\ I_2$ 表示对由Infra2实现的领域服务进行测试。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><blockquote><p>Talk is cheap. Show me the code.</p></blockquote><p>Okay，上面的“理论”可能有点抽象，不是很容易理解。来点实践吧。</p><p>假设场景：一个账户服务，可以开/关户、存/取钱。</p><p>REPO: <a href="https://github.com/a3d21/goddd">https://github.com/a3d21/goddd</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go集合流式API - GoStream</title>
    <link href="/2021/11/16/2021-11-16-gostream/"/>
    <url>/2021/11/16/2021-11-16-gostream/</url>
    
    <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p><a href="https://github.com/a3d21/gostream">GoStream</a>是个参考Java StreamAPI，基于go-linq实现的数据处理库。<br>它可以声明式地对数据进行转换、过滤、排序、分组、收集，而无需关心操作细节。</p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>项目中经常需要对数据进行分组、转换，已有的数据处理库go-linq、go-streams都无法满足我需求。API不友好、不支持多级分组… 所以想新写个Libary，于是，有了GoStream！！</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>更完整的例子，请参考walkthrough.go</p><h3 id="Base-Example"><a href="#Base-Example" class="headerlink" title="Base Example"></a>Base Example</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">input := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>&#125;<br>want := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">6</span>, <span class="hljs-number">8</span>&#125;<br><br>got := From(input).Map(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * it.(<span class="hljs-keyword">int</span>)<br>&#125;).Filter(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br>   <span class="hljs-keyword">return</span> it.(<span class="hljs-keyword">int</span>) &gt; <span class="hljs-number">5</span><br>&#125;).SortedBy(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br>   <span class="hljs-keyword">return</span> it<br>&#125;).Collect(ToSlice([]<span class="hljs-keyword">int</span>(<span class="hljs-literal">nil</span>)))<br><br><span class="hljs-keyword">if</span> !reflect.DeepEqual(got, want) &#123;<br>   <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;%v != %v&quot;</span>, got, want))<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Map-amp-FlatMap"><a href="#Map-amp-FlatMap" class="headerlink" title="Map &amp; FlatMap"></a>Map &amp; FlatMap</h3><p>Map和FlatMap的差别在于：FlatMap的mapper返回一个Stream，用于将多级数据打扁。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">input := [][]<span class="hljs-keyword">int</span>&#123;&#123;<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>&#125;, &#123;<span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>&#125;, &#123;<span class="hljs-number">9</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>&#125;&#125;<br>want := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>got := From(input).FlatMap(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Stream</span></span> &#123;<br>   <span class="hljs-keyword">return</span> From(it)<br>&#125;).SortedBy(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br>   <span class="hljs-keyword">return</span> it<br>&#125;).Collect(ToSlice([]<span class="hljs-keyword">int</span>&#123;&#125;))<br></code></pre></td></tr></table></figure><h3 id="Collect-ToSlice-amp-ToMap"><a href="#Collect-ToSlice-amp-ToMap" class="headerlink" title="Collect ToSlice &amp; ToMap"></a>Collect ToSlice &amp; ToMap</h3><p>Collect将数据收集起来。受限于go的类型系统，需要显示传类型参数——一个目标类型的实例，可以为nil。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">intput := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;<br>identity := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123; <span class="hljs-keyword">return</span> it &#125;<br><br><span class="hljs-comment">// []int&#123;1, 2, 3, 4, 5&#125;</span><br>gotSlice := From(intput).Collect(ToSlice([]<span class="hljs-keyword">int</span>&#123;&#125;))<br><span class="hljs-comment">// map[int]int&#123;1: 1, 2: 2, 3: 3, 4: 4, 5: 5&#125;</span><br>gotMap := From(intput).Collect(ToMap(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">int</span>(<span class="hljs-literal">nil</span>), identity, identity))<br></code></pre></td></tr></table></figure><h3 id="Collect-GroupBy"><a href="#Collect-GroupBy" class="headerlink" title="Collect GroupBy"></a>Collect GroupBy</h3><p>GroupBy定义一个分组收集器，参数依序分别为 类型参数、分类方法、下游收集器。<br>GroupBy可以和ToSlice、ToMap组合，GroupBy也可以多级嵌套，实现多级分组。<br><code>GroupBy(typ interface&#123;&#125;, classifier normalFn, downstream collector) collector</code></p><p>假设一组货物，需要按Status,Location进行分组，目标类型为 map[int]map[string][]*Cargo。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Cargo 货物实体</span><br><span class="hljs-keyword">type</span> Cargo <span class="hljs-keyword">struct</span> &#123;<br>   ID       <span class="hljs-keyword">int</span><br>   Name     <span class="hljs-keyword">string</span><br>   Location <span class="hljs-keyword">string</span><br>   Status   <span class="hljs-keyword">int</span><br>&#125;<br><br>input := []*Cargo&#123;&#123;<br>   ID:       <span class="hljs-number">1</span>,<br>   Name:     <span class="hljs-string">&quot;foo&quot;</span>,<br>   Location: <span class="hljs-string">&quot;shenzhen&quot;</span>,<br>   Status:   <span class="hljs-number">1</span>,<br>&#125;, &#123;<br>   ID:       <span class="hljs-number">2</span>,<br>   Name:     <span class="hljs-string">&quot;bar&quot;</span>,<br>   Location: <span class="hljs-string">&quot;shenzhen&quot;</span>,<br>   Status:   <span class="hljs-number">0</span>,<br>&#125;, &#123;<br>   ID:       <span class="hljs-number">3</span>,<br>   Name:     <span class="hljs-string">&quot;zhang&quot;</span>,<br>   Location: <span class="hljs-string">&quot;guangzhou&quot;</span>,<br>   Status:   <span class="hljs-number">1</span>,<br>&#125;&#125;<br><br>getStatus := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123; <span class="hljs-keyword">return</span> it.(*Cargo).Status &#125;<br>getLocation := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123; <span class="hljs-keyword">return</span> it.(*Cargo).Location &#125;<br><br><span class="hljs-comment">// result type: map[int]map[string][]*Cargo</span><br>got := From(input).Collect(<br>   GroupBy(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]*Cargo(<span class="hljs-literal">nil</span>), getStatus,<br>      GroupBy(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]*Cargo(<span class="hljs-literal">nil</span>), getLocation,<br>         ToSlice([]*Cargo(<span class="hljs-literal">nil</span>)))))<br></code></pre></td></tr></table></figure><h3 id="Flatten-Group"><a href="#Flatten-Group" class="headerlink" title="Flatten Group"></a>Flatten Group</h3><p>这个示例演示如何将多级分组Map扁平化。<code>map[int]map[string][]*Cargo =&gt; []*Cargo</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">From(cargoByLocationByTo).FlatMap(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Stream</span></span> &#123;<br>   <span class="hljs-keyword">return</span> From(it.(KeyValue).Value).FlatMap(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(it2 <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Stream</span></span> &#123;<br>      <span class="hljs-keyword">return</span> From(it2.(KeyValue).Value)<br>   &#125;)<br>&#125;).Collect(ToSlice([]*Cargo&#123;&#125;))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>实现GoCQRS-01：整体设计</title>
    <link href="/2021/11/10/2021-11-10-implement-go-cqrs-01/"/>
    <url>/2021/11/10/2021-11-10-implement-go-cqrs-01/</url>
    
    <content type="html"><![CDATA[<p>最近工作中想基于Event Sourcing重新设计计费系统。团队主要采用Go技术栈，而Go生态不成熟，缺少成熟CQRS框架实现，所以想着自己动手写个。参考<a href="https://axoniq.io/">Axon</a>，整体设计如下。</p><span id="more"></span><img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjgxNHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTIxNHB4O2hlaWdodDo4MTRweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMjE0IDgxNCIgd2lkdGg9IjEyMTRweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIEdvQ1FSUy0tPjxnIGlkPSJjbHVzdGVyX0dvQ1FSUyI+PHBhdGggZD0iTTguNSw2IEw3My42NDg0LDYgQTMuNzUsMy43NSAwIDAgMSA3Ni4xNDg0LDguNSBMODMuMTQ4NCwyOC4yOTY5IEwxMjA0LjUsMjguMjk2OSBBMi41LDIuNSAwIDAgMSAxMjA3LDMwLjc5NjkgTDEyMDcsODA1LjQ3IEEyLjUsMi41IDAgMCAxIDEyMDQuNSw4MDcuOTcgTDguNSw4MDcuOTcgQTIuNSwyLjUgMCAwIDEgNiw4MDUuNDcgTDYsOC41IEEyLjUsMi41IDAgMCAxIDguNSw2ICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI2IiB4Mj0iODMuMTQ4NCIgeTE9IjI4LjI5NjkiIHkyPSIyOC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY0LjE0ODQiIHg9IjEwIiB5PSIyMC45OTUxIj5Hb0NRUlM8L3RleHQ+PC9nPjwhLS1jbGFzcyBDb21tYW5kR2F0ZXdheS0tPjxnIGlkPSJlbGVtX0NvbW1hbmRHYXRld2F5Ij48cmVjdCBjb2RlTGluZT0iMiIgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI4MC41OTM4IiBpZD0iQ29tbWFuZEdhdGV3YXkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU4Ny41MzgxIiB4PSI0Ny4yMyIgeT0iNDEiLz48ZWxsaXBzZSBjeD0iMjY5Ljg0OTEiIGN5PSI1NyIgZmlsbD0iI0I0QTdFNSIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjY1Ljc3MSw1Mi43NjU2IEwyNjUuNzcxLDUwLjYwOTQgTDI3My4xNjE2LDUwLjYwOTQgTDI3My4xNjE2LDUyLjc2NTYgTDI3MC42OTI5LDUyLjc2NTYgTDI3MC42OTI5LDYwLjg0MzggTDI3My4xNjE2LDYwLjg0MzggTDI3My4xNjE2LDYzIEwyNjUuNzcxLDYzIEwyNjUuNzcxLDYwLjg0MzggTDI2OC4yMzk4LDYwLjg0MzggTDI2OC4yMzk4LDUyLjc2NTYgTDI2NS43NzEsNTIuNzY1NiBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMzLjc5OTgiIHg9IjI5MC4zNDkxIiB5PSI2MS44NDY3Ij5Db21tYW5kR2F0ZXdheTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI0OC4yMyIgeDI9IjYzMy43NjgxIiB5MT0iNzMiIHkyPSI3MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjUzLjIzIiB5PSI4OS45OTUxIj4mIzIxNjI5OyYjMjAxOTY7JiMzMjU5MzsmIzIwODUxOzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI0OC4yMyIgeDI9IjYzMy43NjgxIiB5MT0iOTcuMjk2OSIgeTI9Ijk3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NzUuNTM4MSIgeD0iNTMuMjMiIHk9IjExNC4yOTIiPlNlbmRBbmRXYWl0KGN0eCBjb250ZXh0LkNvbnRleHQsIGNtZCBpbnRlcmZhY2V7fSkgKHJlc3VsdCBpbnRlcmZhY2V7fSwgZXJyIGVycm9yKTwvdGV4dD48L2c+PCEtLWNsYXNzIFF1ZXJ5R2F0ZXdheS0tPjxnIGlkPSJlbGVtX1F1ZXJ5R2F0ZXdheSI+PHJlY3QgY29kZUxpbmU9IjYiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iODAuNTkzOCIgaWQ9IlF1ZXJ5R2F0ZXdheSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzk3LjgyMDMiIHg9IjY3MC4wOSIgeT0iNDEiLz48ZWxsaXBzZSBjeD0iODEyLjU1NDQiIGN5PSI1NyIgZmlsbD0iI0I0QTdFNSIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNODA4LjQ3NjIsNTIuNzY1NiBMODA4LjQ3NjIsNTAuNjA5NCBMODE1Ljg2NjksNTAuNjA5NCBMODE1Ljg2NjksNTIuNzY1NiBMODEzLjM5ODEsNTIuNzY1NiBMODEzLjM5ODEsNjAuODQzOCBMODE1Ljg2NjksNjAuODQzOCBMODE1Ljg2NjksNjMgTDgwOC40NzYyLDYzIEw4MDguNDc2Miw2MC44NDM4IEw4MTAuOTQ1LDYwLjg0MzggTDgxMC45NDUsNTIuNzY1NiBMODA4LjQ3NjIsNTIuNzY1NiBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjM5MTYiIHg9IjgzMy4wNTQ0IiB5PSI2MS44NDY3Ij5RdWVyeUdhdGV3YXk8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNjcxLjA5IiB4Mj0iMTA2Ni45MTAzIiB5MT0iNzMiIHkyPSI3MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjY3Ni4wOSIgeT0iODkuOTk1MSI+JiMyNjU5NzsmIzM1ODEwOyYjMzI1OTM7JiMyMDg1MTs8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNjcxLjA5IiB4Mj0iMTA2Ni45MTAzIiB5MT0iOTcuMjk2OSIgeTI9Ijk3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzODUuODIwMyIgeD0iNjc2LjA5IiB5PSIxMTQuMjkyIj5RdWVyeShjdHggY29udGV4dC5Db250ZXh0LCBpZCBzdHJpbmcpKEFnZ3JlZ2F0ZSwgZXJyb3IpPC90ZXh0PjwvZz48IS0tY2xhc3MgQ1FSU1N5c3RlbS0tPjxnIGlkPSJlbGVtX0NRUlNTeXN0ZW0iPjxyZWN0IGNvZGVMaW5lPSIxMSIgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI0OCIgaWQ9IkNRUlNTeXN0ZW0iIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyMy42MTUyIiB4PSIzMDQuMTkiIHk9IjE4MS42Ii8+PGVsbGlwc2UgY3g9IjMxOS4xOSIgY3k9IjE5Ny42IiBmaWxsPSIjQUREMUIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0zMjIuMTU4OCwyMDMuMjQwNiBRMzIxLjU4MDYsMjAzLjUzNzUgMzIwLjk0LDIwMy42NzgxIFEzMjAuMjk5NCwyMDMuODM0NCAzMTkuNTk2MywyMDMuODM0NCBRMzE3LjA5NjMsMjAzLjgzNDQgMzE1Ljc2ODEsMjAyLjE5MzggUTMxNC40NTU2LDIwMC41Mzc1IDMxNC40NTU2LDE5Ny40MTI1IFEzMTQuNDU1NiwxOTQuMjg3NSAzMTUuNzY4MSwxOTIuNjMxMyBRMzE3LjA5NjMsMTkwLjk3NSAzMTkuNTk2MywxOTAuOTc1IFEzMjAuMjk5NCwxOTAuOTc1IDMyMC45NCwxOTEuMTMxMyBRMzIxLjU5NjMsMTkxLjI4NzUgMzIyLjE1ODgsMTkxLjU4NDQgTDMyMi4xNTg4LDE5NC4zMDMxIFEzMjEuNTMzOCwxOTMuNzI1IDMyMC45NCwxOTMuNDU5NCBRMzIwLjM0NjMsMTkzLjE3ODEgMzE5LjcyMTMsMTkzLjE3ODEgUTMxOC4zNzc1LDE5My4xNzgxIDMxNy42OSwxOTQuMjU2MyBRMzE3LjAwMjUsMTk1LjMxODggMzE3LjAwMjUsMTk3LjQxMjUgUTMxNy4wMDI1LDE5OS41MDYzIDMxNy42OSwyMDAuNTg0NCBRMzE4LjM3NzUsMjAxLjY0NjkgMzE5LjcyMTMsMjAxLjY0NjkgUTMyMC4zNDYzLDIwMS42NDY5IDMyMC45NCwyMDEuMzgxMyBRMzIxLjUzMzgsMjAxLjEgMzIyLjE1ODgsMjAwLjUyMTkgTDMyMi4xNTg4LDIwMy4yNDA2IFogIiBmaWxsPSIjMDAwMDAwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuNjE1MiIgeD0iMzMzLjE5IiB5PSIyMDIuNDQ2NyI+Q1FSU1N5c3RlbTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIzMDUuMTkiIHgyPSI0MjYuODA1MiIgeTE9IjIxMy42IiB5Mj0iMjEzLjYiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIzMDUuMTkiIHgyPSI0MjYuODA1MiIgeTE9IjIyMS42IiB5Mj0iMjIxLjYiLz48L2c+PCEtLWNsYXNzIENvbW1hbmRCdXMtLT48ZyBpZD0iZWxlbV9Db21tYW5kQnVzIj48cmVjdCBjb2RlTGluZT0iMTIiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNjQuMjk2OSIgaWQ9IkNvbW1hbmRCdXMiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyOS43MjY2IiB4PSIzNTAuMTQiIHk9IjI4OS42Ii8+PGVsbGlwc2UgY3g9IjM2NS4xNCIgY3k9IjMwNS42IiBmaWxsPSIjQTlEQ0RGIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0zNjUuMjQ5NCwzMDAuOTQzOCBMMzY0LjA5MzEsMzA2LjAyMTkgTDM2Ni40MjEzLDMwNi4wMjE5IEwzNjUuMjQ5NCwzMDAuOTQzOCBaIE0zNjMuNzY1LDI5OC43MDk0IEwzNjYuNzQ5NCwyOTguNzA5NCBMMzcwLjEwODgsMzExLjEgTDM2Ny42NTU2LDMxMS4xIEwzNjYuODksMzA4LjAzNzUgTDM2My42MDg4LDMwOC4wMzc1IEwzNjIuODU4OCwzMTEuMSBMMzYwLjQyMTMsMzExLjEgTDM2My43NjUsMjk4LjcwOTQgWiAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC1zdHlsZT0iaXRhbGljIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk3LjcyNjYiIHg9IjM3OS4xNCIgeT0iMzEwLjQ0NjciPkNvbW1hbmRCdXM8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMzUxLjE0IiB4Mj0iNDc4Ljg2NjYiIHkxPSIzMjEuNiIgeTI9IjMyMS42Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMzU2LjE0IiB5PSIzMzguNTk1MSI+JiMyNTUxMjsmIzM2ODY1OyYjMjE2Mjk7JiMyMDE5Njs8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMzUxLjE0IiB4Mj0iNDc4Ljg2NjYiIHkxPSIzNDUuODk2OSIgeTI9IjM0NS44OTY5Ii8+PC9nPjwhLS1jbGFzcyBFdmVudEJ1cy0tPjxnIGlkPSJlbGVtX0V2ZW50QnVzIj48cmVjdCBjb2RlTGluZT0iMTYiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNjQuMjk2OSIgaWQ9IkV2ZW50QnVzIiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMDguMTA2MiIgeD0iMTc3Ljk1IiB5PSI3MjcuNjciLz48ZWxsaXBzZSBjeD0iMTk3LjU1MjciIGN5PSI3NDMuNjciIGZpbGw9IiNBOURDREYiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTE5Ny42NjIxLDczOS4wMTM4IEwxOTYuNTA1OCw3NDQuMDkxOSBMMTk4LjgzNCw3NDQuMDkxOSBMMTk3LjY2MjEsNzM5LjAxMzggWiBNMTk2LjE3NzcsNzM2Ljc3OTQgTDE5OS4xNjIxLDczNi43Nzk0IEwyMDIuNTIxNSw3NDkuMTcgTDIwMC4wNjgzLDc0OS4xNyBMMTk5LjMwMjcsNzQ2LjEwNzUgTDE5Ni4wMjE1LDc0Ni4xMDc1IEwxOTUuMjcxNSw3NDkuMTcgTDE5Mi44MzQsNzQ5LjE3IEwxOTYuMTc3Nyw3MzYuNzc5NCBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuODc3OSIgeD0iMjEyLjU3NTUiIHk9Ijc0OC41MTY3Ij5FdmVudEJ1czwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxNzguOTUiIHgyPSIyODUuMDU2MiIgeTE9Ijc1OS42NyIgeTI9Ijc1OS42NyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk2LjEwNjIiIHg9IjE4My45NSIgeT0iNzc2LjY2NTEiPiYjMzYxMjc7JiMzNjEzMTsmIzI1NTEyOyYjMzY4NjU7RXZlbnQ8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTc4Ljk1IiB4Mj0iMjg1LjA1NjIiIHkxPSI3ODMuOTY2OSIgeTI9Ijc4My45NjY5Ii8+PC9nPjwhLS1jbGFzcyBFdmVudFNvdXJjaW5nUmVwb3NpdG9yeS0tPjxnIGlkPSJlbGVtX0V2ZW50U291cmNpbmdSZXBvc2l0b3J5Ij48cmVjdCBjb2RlTGluZT0iMTkiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNjQuMjk2OSIgaWQ9IkV2ZW50U291cmNpbmdSZXBvc2l0b3J5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1ODMuMTQ5MyIgeD0iMjIuNDMiIHk9IjQzMC4xOSIvPjxlbGxpcHNlIGN4PSIyMjEuNDUxNCIgY3k9IjQ0Ni4xOSIgZmlsbD0iI0E5RENERiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjIxLjU2MDgsNDQxLjUzMzggTDIyMC40MDQ1LDQ0Ni42MTE5IEwyMjIuNzMyNyw0NDYuNjExOSBMMjIxLjU2MDgsNDQxLjUzMzggWiBNMjIwLjA3NjQsNDM5LjI5OTQgTDIyMy4wNjA4LDQzOS4yOTk0IEwyMjYuNDIwMiw0NTEuNjkgTDIyMy45NjcsNDUxLjY5IEwyMjMuMjAxNCw0NDguNjI3NSBMMjE5LjkyMDIsNDQ4LjYyNzUgTDIxOS4xNzAyLDQ1MS42OSBMMjE2LjczMjcsNDUxLjY5IEwyMjAuMDc2NCw0MzkuMjk5NCBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc2LjYwNjQiIHg9IjI0MS45NTE0IiB5PSI0NTEuMDM2NyI+RXZlbnRTb3VyY2luZ1JlcG9zaXRvcnk8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjMuNDMiIHgyPSI2MDQuNTc5MyIgeTE9IjQ2Mi4xOSIgeTI9IjQ2Mi4xOSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjIzLjQzIiB4Mj0iNjA0LjU3OTMiIHkxPSI0NzAuMTkiIHkyPSI0NzAuMTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NzEuMTQ5MyIgeD0iMjguNDMiIHk9IjQ4Ny4xODUxIj5Mb2FkKGN0eCBjb250ZXh0LkNvbnRleHQsIGFnZ3JlZ2F0ZUlEIHN0cmluZykgKEFnZ3JlZ2F0ZSwgZXJyb3IpIC8vJiMyMTE1MjsmIzM2NzMzO0FnZ3JlZ2F0ZTwvdGV4dD48L2c+PCEtLWNsYXNzIEV2ZW50U3RvcmUtLT48ZyBpZD0iZWxlbV9FdmVudFN0b3JlIj48cmVjdCBjb2RlTGluZT0iMjMiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iOTYuODkwNiIgaWQ9IkV2ZW50U3RvcmUiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ1OC4yNSIgeD0iODQuODgiIHk9IjU3MC43OCIvPjxlbGxpcHNlIGN4PSIyNzEuMDQ2NSIgY3k9IjU4Ni43OCIgZmlsbD0iI0E5RENERiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjcxLjE1NTksNTgyLjEyMzggTDI2OS45OTk2LDU4Ny4yMDE5IEwyNzIuMzI3OCw1ODcuMjAxOSBMMjcxLjE1NTksNTgyLjEyMzggWiBNMjY5LjY3MTUsNTc5Ljg4OTQgTDI3Mi42NTU5LDU3OS44ODk0IEwyNzYuMDE1Myw1OTIuMjggTDI3My41NjIxLDU5Mi4yOCBMMjcyLjc5NjUsNTg5LjIxNzUgTDI2OS41MTUzLDU4OS4yMTc1IEwyNjguNzY1Myw1OTIuMjggTDI2Ni4zMjc4LDU5Mi4yOCBMMjY5LjY3MTUsNTc5Ljg4OTQgWiAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC1zdHlsZT0iaXRhbGljIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc3LjQxNyIgeD0iMjkxLjU0NjUiIHk9IjU5MS42MjY3Ij5FdmVudFN0b3JlPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9Ijg1Ljg4IiB4Mj0iNTQyLjEzIiB5MT0iNjAyLjc4IiB5Mj0iNjAyLjc4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUyLjEwNiIgeD0iOTAuODgiIHk9IjYxOS43NzUxIj4mIzM2MTI3OyYjMzYxMzE7JiMyNTM0NTsmIzIwMDM3OyYjMjEyNzA7JiMyNDE4MjsmIzI1NTEyOyYjMzY4NjU7RXZlbnQ8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iODUuODgiIHgyPSI1NDIuMTMiIHkxPSI2MjcuMDc2OSIgeTI9IjYyNy4wNzY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDQ2LjI1IiB4PSI5MC44OCIgeT0iNjQ0LjA3MiI+U2F2ZShjdHggY29udGV4dC5Db250ZXh0LCBjbWQgKkNvbW1hbmQsIGV2dHMgW10qRXZlbnQpIGVycm9yPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ0MC43MTk3IiB4PSI5MC44OCIgeT0iNjYwLjM2ODkiPkxvYWQoY3R4IGNvbnRleHQuQ29udGV4dCwgYWdncmVnYXRlSUQgc3RyaW5nKSAoW10qRXZlbnQsIGVycm9yKTwvdGV4dD48L2c+PCEtLWNsYXNzIEV2ZW50UmVwb3NpdG9yeS0tPjxnIGlkPSJlbGVtX0V2ZW50UmVwb3NpdG9yeSI+PHJlY3QgY29kZUxpbmU9IjI4IiBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjY0LjI5NjkiIGlkPSJFdmVudFJlcG9zaXRvcnkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0Ny4xNzg3IiB4PSIzMjEuNDEiIHk9IjcyNy42NyIvPjxlbGxpcHNlIGN4PSIzMzYuNDEiIGN5PSI3NDMuNjciIGZpbGw9IiNCNEE3RTUiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTMzMi4zMzE5LDczOS40MzU2IEwzMzIuMzMxOSw3MzcuMjc5NCBMMzM5LjcyMjUsNzM3LjI3OTQgTDMzOS43MjI1LDczOS40MzU2IEwzMzcuMjUzOCw3MzkuNDM1NiBMMzM3LjI1MzgsNzQ3LjUxMzggTDMzOS43MjI1LDc0Ny41MTM4IEwzMzkuNzIyNSw3NDkuNjcgTDMzMi4zMzE5LDc0OS42NyBMMzMyLjMzMTksNzQ3LjUxMzggTDMzNC44MDA2LDc0Ny41MTM4IEwzMzQuODAwNiw3MzkuNDM1NiBMMzMyLjMzMTksNzM5LjQzNTYgWiAiIGZpbGw9IiMwMDAwMDAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC1zdHlsZT0iaXRhbGljIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNS4xNzg3IiB4PSIzNTAuNDEiIHk9Ijc0OC41MTY3Ij5FdmVudFJlcG9zaXRvcnk8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMzIyLjQxIiB4Mj0iNDY3LjU4ODciIHkxPSI3NTkuNjciIHkyPSI3NTkuNjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTAuMTA2MSIgeD0iMzI3LjQxIiB5PSI3NzYuNjY1MSI+JiMzNjEyNzsmIzM2MTMxO0V2ZW50JiMyNTM0NTsmIzIwMDM3OyYjMjEyNzA7PC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjMyMi40MSIgeDI9IjQ2Ny41ODg3IiB5MT0iNzgzLjk2NjkiIHkyPSI3ODMuOTY2OSIvPjwvZz48IS0tY2xhc3MgQWdncmVnYXRlLS0+PGcgaWQ9ImVsZW1fQWdncmVnYXRlIj48cmVjdCBjb2RlTGluZT0iMzEiIGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iOTYuODkwNiIgaWQ9IkFnZ3JlZ2F0ZSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDA0LjA3NTEiIHg9Ijc4Ni45NiIgeT0iNDEzLjg5Ii8+PGVsbGlwc2UgY3g9Ijk0OC4xMDM1IiBjeT0iNDI5Ljg5IiBmaWxsPSIjQTlEQ0RGIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik05NDguMjEyOSw0MjUuMjMzOCBMOTQ3LjA1NjYsNDMwLjMxMTkgTDk0OS4zODQ3LDQzMC4zMTE5IEw5NDguMjEyOSw0MjUuMjMzOCBaIE05NDYuNzI4NSw0MjIuOTk5NCBMOTQ5LjcxMjksNDIyLjk5OTQgTDk1My4wNzIyLDQzNS4zOSBMOTUwLjYxOTEsNDM1LjM5IEw5NDkuODUzNSw0MzIuMzI3NSBMOTQ2LjU3MjIsNDMyLjMyNzUgTDk0NS44MjIyLDQzNS4zOSBMOTQzLjM4NDcsNDM1LjM5IEw5NDYuNzI4NSw0MjIuOTk5NCBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzMuMjg4MSIgeD0iOTY4LjYwMzUiIHk9IjQzNC43MzY3Ij5BZ2dyZWdhdGU8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNzg3Ljk2IiB4Mj0iMTE5MC4wMzUxIiB5MT0iNDQ1Ljg5IiB5Mj0iNDQ1Ljg5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNzg3Ljk2IiB4Mj0iMTE5MC4wMzUxIiB5MT0iNDUzLjg5IiB5Mj0iNDUzLjg5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTcyLjU1MjciIHg9Ijc5Mi45NiIgeT0iNDcwLjg4NTEiPklEKCkgc3RyaW5nIC8vQWdncmVnYXRlSUQ8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzkyLjA3NTEiIHg9Ijc5Mi45NiIgeT0iNDg3LjE4MiI+QXBwbHkoY3R4IGNvbnRleHQuQ29udGV4dCwgZXZ0ICpFdmVudCkgZXJyb3IgLy9BcHBseSYjMjAxMDc7JiMyMDIxNDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc0LjU2OTIiIHg9Ijc5Mi45NiIgeT0iNTAzLjQ3ODkiPlN0YXRlKCkgaW50ZXJmYWNle30gLy8mIzI5MzY2OyYjMjQ1Nzc7PC90ZXh0PjwvZz48IS0tY2xhc3MgU25hcHNob3Rlci0tPjxnIGlkPSJlbGVtX1NuYXBzaG90ZXIiPjxyZWN0IGNvZGVMaW5lPSIzNyIgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI2NC4yOTY5IiBpZD0iU25hcHNob3RlciIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTExLjgxNjQiIHg9IjY0MC4wOSIgeT0iNDMwLjE5Ii8+PGVsbGlwc2UgY3g9IjY1NS4wOSIgY3k9IjQ0Ni4xOSIgZmlsbD0iI0E5RENERiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNNjU1LjE5OTQsNDQxLjUzMzggTDY1NC4wNDMxLDQ0Ni42MTE5IEw2NTYuMzcxMyw0NDYuNjExOSBMNjU1LjE5OTQsNDQxLjUzMzggWiBNNjUzLjcxNSw0MzkuMjk5NCBMNjU2LjY5OTQsNDM5LjI5OTQgTDY2MC4wNTg4LDQ1MS42OSBMNjU3LjYwNTYsNDUxLjY5IEw2NTYuODQsNDQ4LjYyNzUgTDY1My41NTg4LDQ0OC42Mjc1IEw2NTIuODA4OCw0NTEuNjkgTDY1MC4zNzEzLDQ1MS42OSBMNjUzLjcxNSw0MzkuMjk5NCBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzkuODE2NCIgeD0iNjY5LjA5IiB5PSI0NTEuMDM2NyI+U25hcHNob3RlcjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI2NDEuMDkiIHgyPSI3NTAuOTA2NCIgeTE9IjQ2Mi4xOSIgeTI9IjQ2Mi4xOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjY0Ni4wOSIgeT0iNDc5LjE4NTEiPiYjMzYxMjc7JiMzNjEzMTsmIzI0NTU1OyYjMjkwMzE7JiMyNjQyNjsmIzIxMDQ2OzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI2NDEuMDkiIHgyPSI3NTAuOTA2NCIgeTE9IjQ4Ni40ODY5IiB5Mj0iNDg2LjQ4NjkiLz48L2c+PCEtLXJldmVyc2UgbGluayBDb21tYW5kR2F0ZXdheSB0byBDUVJTU3lzdGVtLS0+PGcgaWQ9ImxpbmtfQ29tbWFuZEdhdGV3YXlfQ1FSU1N5c3RlbSI+PHBhdGggY29kZUxpbmU9IjQwIiBkPSJNMzUyLjcyMywxMzkuNjM1NyBDMzU2LjcxMywxNTkuMTY1NyAzNTcuNzgsMTY0LjQgMzYxLjIsMTgxLjEyICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBpZD0iQ29tbWFuZEdhdGV3YXktYmFja3RvLUNRUlNTeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBwb2ludHM9IjM0OS4xMiwxMjIsMzQ2Ljg0NDQsMTQwLjgzNjcsMzU4LjYwMTYsMTM4LjQzNDcsMzQ5LjEyLDEyMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIFF1ZXJ5R2F0ZXdheSB0byBDUVJTU3lzdGVtLS0+PGcgaWQ9ImxpbmtfUXVlcnlHYXRld2F5X0NRUlNTeXN0ZW0iPjxwYXRoIGNvZGVMaW5lPSI0MSIgZD0iTTY4Ny44NDk2LDEyNi4zNDI5IEM1OTMuMjE5NiwxNDkuMzUyOSA0OTcuMDksMTcyLjcyIDQyOC4yOCwxODkuNDUgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGlkPSJRdWVyeUdhdGV3YXktYmFja3RvLUNRUlNTeXN0ZW0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBwb2ludHM9IjcwNS4zNCwxMjIuMDksNjg2LjQzMiwxMjAuNTEyOCw2ODkuMjY3MywxMzIuMTczLDcwNS4zNCwxMjIuMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnkgdG8gRXZlbnRTdG9yZS0tPjxnIGlkPSJsaW5rX0V2ZW50U291cmNpbmdSZXBvc2l0b3J5X0V2ZW50U3RvcmUiPjxwYXRoIGNvZGVMaW5lPSI0MiIgZD0iTTMxNCw0OTQuNjggQzMxNCw1MTYuNDMgMzE0LDUzOS44IDMxNCw1NjQuNDUgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGlkPSJFdmVudFNvdXJjaW5nUmVwb3NpdG9yeS10by1FdmVudFN0b3JlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzMTQsNTcwLjQ1LDMxOCw1NjEuNDUsMzE0LDU2NS40NSwzMTAsNTYxLjQ1LDMxNCw1NzAuNDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnkgdG8gQWdncmVnYXRlLS0+PGcgaWQ9ImxpbmtfRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnlfQWdncmVnYXRlIj48cGF0aCBjb2RlTGluZT0iNDMiIGQ9Ik0zOTkuMzUsNDI5Ljc5IEM0ODcuNDIsNDAwLjI3IDYyOC44NCwzNjQuMTYgNzUxLjUsMzgzLjg5IEM3ODkuNTUsMzkwLjAxIDgyNC4wNzA3LDM5OS40MTQyIDg2MC4zNzA3LDQxMS41NzQyICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBpZD0iRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnktdG8tQWdncmVnYXRlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI4NjYuMDYsNDEzLjQ4LDg1OC43OTY2LDQwNi44Mjg0LDg2MS4zMTg5LDQxMS44OTE4LDg1Ni4yNTU1LDQxNC40MTQxLDg2Ni4wNiw0MTMuNDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnkgdG8gU25hcHNob3Rlci0tPjxnIGlkPSJsaW5rX0V2ZW50U291cmNpbmdSZXBvc2l0b3J5X1NuYXBzaG90ZXIiPjxwYXRoIGNvZGVMaW5lPSI0NCIgZD0iTTYwNS43Miw0NjIuMzQgQzYxNy4xMiw0NjIuMzQgNjIyLjUzLDQ2Mi4zNCA2MzMuOTMsNDYyLjM0ICIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBpZD0iRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnktdG8tU25hcHNob3RlciIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjM5LjkzLDQ2Mi4zNCw2MzAuOTMsNDU4LjM0LDYzNC45Myw0NjIuMzQsNjMwLjkzLDQ2Ni4zNCw2MzkuOTMsNDYyLjM0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1saW5rIEV2ZW50U3RvcmUgdG8gRXZlbnRSZXBvc2l0b3J5LS0+PGcgaWQ9ImxpbmtfRXZlbnRTdG9yZV9FdmVudFJlcG9zaXRvcnkiPjxwYXRoIGNvZGVMaW5lPSI0NSIgZD0iTTM0MS44OCw2NjcuOTIgQzM1My40MSw2ODcuNjYgMzYzLjQzMjYsNzA0Ljc5OTggMzczLjcxMjYsNzIyLjM4OTggIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGlkPSJFdmVudFN0b3JlLXRvLUV2ZW50UmVwb3NpdG9yeSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc2Ljc0LDcyNy41NywzNzUuNjUyMyw3MTcuNzgxNCwzNzQuMjE3MSw3MjMuMjUzMiwzNjguNzQ1NCw3MjEuODE4LDM3Ni43NCw3MjcuNTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgRXZlbnRTdG9yZSB0byBFdmVudEJ1cy0tPjxnIGlkPSJsaW5rX0V2ZW50U3RvcmVfRXZlbnRCdXMiPjxwYXRoIGNvZGVMaW5lPSI0NiIgZD0iTTI4NS43OCw2NjcuOTIgQzI3NC4xMSw2ODcuNjYgMjYzLjk1NTgsNzA0LjgxNjUgMjUzLjU0NTgsNzIyLjQwNjUgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGlkPSJFdmVudFN0b3JlLXRvLUV2ZW50QnVzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNTAuNDksNzI3LjU3LDI1OC41MTYxLDcyMS44NjIsMjUzLjAzNjUsNzIzLjI2NzEsMjUxLjYzMTQsNzE3Ljc4NzUsMjUwLjQ5LDcyNy41NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBDUVJTU3lzdGVtIHRvIEV2ZW50U291cmNpbmdSZXBvc2l0b3J5LS0+PGcgaWQ9ImxpbmtfQ1FSU1N5c3RlbV9FdmVudFNvdXJjaW5nUmVwb3NpdG9yeSI+PHBhdGggY29kZUxpbmU9IjQ3IiBkPSJNMzU0LjczLDIzMC4wMSBDMzQ3LjM2LDI0Ni4zMyAzMzguMTgsMjY4LjgzIDMzMywyODkuNiBDMzIxLjAzLDMzNy42MiAzMTYuODgyNSwzODkuMDg2NyAzMTUuMjQyNSw0MjMuODc2NyAiIGZpbGw9IiNGRkZGRkYiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaWQ9IkNRUlNTeXN0ZW0tdG8tRXZlbnRTb3VyY2luZ1JlcG9zaXRvcnkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjMxNC45Niw0MjkuODcsMzE5LjM3OTQsNDIxLjA2ODMsMzE1LjE5NTQsNDI0Ljg3NTUsMzExLjM4ODIsNDIwLjY5MTYsMzE0Ljk2LDQyOS44NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBDUVJTU3lzdGVtIHRvIENvbW1hbmRCdXMtLT48ZyBpZD0ibGlua19DUVJTU3lzdGVtX0NvbW1hbmRCdXMiPjxwYXRoIGNvZGVMaW5lPSI0OCIgZD0iTTM3Ni4wMywyMjkuOTcgQzM4My4zNywyNDcuMDYgMzkxLjAzMjksMjY0LjkxNjcgMzk5LjA4MjksMjgzLjY2NjcgIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGlkPSJDUVJTU3lzdGVtLXRvLUNvbW1hbmRCdXMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQwMS40NSwyODkuMTgsNDAxLjU3NSwyNzkuMzMxOSwzOTkuNDc3NCwyODQuNTg1NSwzOTQuMjIzOCwyODIuNDg4LDQwMS40NSwyODkuMTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLVNSQz1bZExKQklpRDA1RHR4NVJEaUlncV84OExRSEdHdGNlS0JTSjRjT21vc2NKMHBoUFBRaThrMmcwWGtOMGNBM25IU2tCMEtnWEhfZmNkaE5wWVBqOUY5ZXJxT0E4NnZ2enZ4cGtjUGtEMHVXWE8yd3hZcWpRczNuV0JXWi1xbUgwd1dXSzA5TG9oR0NUU1hHeVVtRllkeFp0Vko3dG1fWl9ldE5sako3a2g4Q09rRWtHRGpiWjdPMkowbTd0SjJ5Z05XZEdENm5HbzdEdmVRbzExNGdzTWM3a08wOGlKX09RQTlvU3FPZndxZzhsS2FlLTd6b19aWkNTUDhPREV2czJRV1pEWUVmTU1BYmFNR25JVmNlZGw1b29YM0llN2xaYndkMzVONDhUcGRsVDFXS3VETWdiSWJTbHRzVXpPQUI1OTdvUXdyNmQ5T2o2VlNrSHp0ZGU5RUtMUXFIX2pxTjJLNnZ4c0RONG5qWGVkZ21ZUTZQaGZVRTFNdmlKZUwzZkJBbVRBSVRfNG14bFRiSFU2SEhlUmxIcWFQTHdyMWgtclR0Tmd6UmJvSTIwZ2llVGE5b0t2Q3ZQbmdaOEJUbFFwZXJXQUFfdkt3N1BFUmJvczFJM0tzNDJSZ0tidFFOb0h6S3RldExaRlFYMFp0am5Zb2F1WVl3dlBkdjlIeDAyODYtMkR5LUUzaFNsM1QzSnJiVjJKVmVybWJaWG5UVDhUZGhUR0d3V3Zxd0k3Y3c4SEN4LVR6cjd1VHRkcnZ2cnI1UEVuaGk3b1FweVNsSGtIb2ZXNWNITlhuaVEwYVFad3EwQUJmZDBDQ0hJZjhhTGN2QzZvTzJVNU5ESjEwUWs0cklKWW5FOGFqQTEtQVhVT1ZdLS0+PC9nPjwvc3ZnPg=='>]]></content>
    
    
    
    <tags>
      
      <tag>编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>读《荷兰牧场和父老乡亲》感</title>
    <link href="/2021/11/04/2021-11-04-dutch-pasture/"/>
    <url>/2021/11/04/2021-11-04-dutch-pasture/</url>
    
    <content type="html"><![CDATA[<p>《荷兰牧场和父老乡亲》是我最喜欢的一篇王小波杂文。</p><span id="more"></span><p>王小波去荷兰旅游，被荷兰牧场的景象所吸引。牧场在一片低洼地里，远低于运河的水面，茵茵的绿草上奶牛在吃草。原来，这里有十七世纪荷兰人建造的，由风车、运河组成的精巧排水系统。哪怕天降大雨，牧场也不会积水。</p><p>在他老家，人们用独轮车送猪粪。独轮车极难操纵，稍有不慎就会连人带车翻掉。人们练就一身本领，能在各种路上走。但不管技巧多高，总免不了栽跟头，摔得鼻青脸肿。</p><p>而且那些所谓“猪粪”，其实是垫猪圈的土。学大寨时要凑上报数字，常常刚垫上，猪还来不及在上面排泄就挖出来。</p><p>运猪粪未必比运水有价值。这种活应该让机器去做，犯不着用宝贵人力。</p><p>在团队中，如果缺乏长远整体思考，很容易陷入这样的困境——做的所有事情好像都没错，但效果甚微，甚至无意义。而人们陷入某种无意义的竞争中，可能是运粪车，也可能是加班死卷。</p><!-- 这是全局最优解和局部最优解的差别。面对难题，我们常常有两种不同的处理方式。比如，在开发工作中，面对粪山一样的代码和低效的协作流程，可以1. 重构代码，改造流程1. 磨练技巧，使自己在粪山代码和低效流程中游刃有余很多时候，重构和改造需要承担相应风险，所以人们更愿意选择独自磨练技巧。磨练技巧的好处是，当你技巧足够高超，在遇到只有你能轻松处理的问题时，容易使自己显得重要，并收割关注度。所以在某些场景，他们作为既得利益者会极力反对重构。当他们占团队的大多数时，团队就会陷入王小波老家一样的困境。对于个人，如果无法改变环境，那就换环境吧。 -->]]></content>
    
    
    
    <tags>
      
      <tag>随笔</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
